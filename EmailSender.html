<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒ¡ãƒ¼ãƒ«é€ä¿¡ - è²·å‡ºäººç« ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ“§</text></svg>">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Hiragino Sans", "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
    .header {
      text-align: center;
      margin-bottom: 0;
      color: white;
    }
    
    .header h1 {
      font-size: 28px;
      margin-bottom: 5px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    
    .header p {
      opacity: 0.9;
    }
    
    /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
    .nav-tabs {
      display: flex;
      gap: 5px;
      margin-bottom: -1px;
      margin-top: 8px;
    }
    
    .nav-tab {
      padding: 12px 24px;
      background: rgba(255,255,255,0.2);
      border: none;
      border-radius: 8px 8px 0 0;
      color: white;
      font-size: 15px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .nav-tab.active {
      background: white;
      color: #667eea;
      font-weight: bold;
    }
    
    .nav-tab:hover:not(.active) {
      background: rgba(255,255,255,0.3);
    }
    
    /* ãƒ¡ã‚¤ãƒ³ã‚«ãƒ¼ãƒ‰ */
    .card {
      background: white;
      border-radius: 0 12px 12px 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      padding: 25px;
      display: none;
    }
    
    .card.active {
      display: block;
    }
    
    /* ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒˆãƒ« */
    .section-title {
      font-size: 18px;
      font-weight: bold;
      color: #333;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #667eea;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    /* 2ã‚«ãƒ©ãƒ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
    .two-column {
      display: grid;
      grid-template-columns: 350px 1fr;
      gap: 25px;
    }
    
    /* å®›å…ˆé¸æŠãƒ‘ãƒãƒ« */
    .recipient-panel {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 20px;
      max-height: 600px;
      display: flex;
      flex-direction: column;
    }
    
    .filter-section {
      margin-bottom: 15px;
    }
    
    .filter-section label {
      display: block;
      font-size: 13px;
      color: #666;
      margin-bottom: 5px;
    }
    
    .filter-section select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }
    
    .recipient-list {
      flex: 1;
      overflow-y: auto;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      background: white;
    }
    
    .recipient-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-bottom: 1px solid #e9ecef;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .recipient-item:hover {
      background: #f0f4ff;
    }
    
    .recipient-item:last-child {
      border-bottom: none;
    }
    
    .recipient-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    
    .recipient-info {
      flex: 1;
      min-width: 0;
    }
    
    .recipient-name {
      font-weight: 500;
      font-size: 14px;
      color: #333;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .recipient-detail {
      font-size: 12px;
      color: #666;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .recipient-status {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 10px;
      font-weight: bold;
    }
    
    .status-active {
      background: #d4edda;
      color: #155724;
    }
    
    .status-inactive {
      background: #f8d7da;
      color: #721c24;
    }
    
    .selection-controls {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    
    .selection-controls button {
      flex: 1;
      padding: 8px;
      border: 1px solid #ddd;
      background: white;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .selection-controls button:hover {
      background: #667eea;
      color: white;
      border-color: #667eea;
    }
    
    .selected-count {
      text-align: center;
      padding: 10px;
      background: #e3f2fd;
      border-radius: 6px;
      margin-top: 10px;
      font-size: 14px;
      color: #1976d2;
      font-weight: 500;
    }
    
    /* ãƒ¡ãƒ¼ãƒ«ä½œæˆãƒ‘ãƒãƒ« */
    .compose-panel {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    
    .form-group label {
      font-size: 14px;
      font-weight: 500;
      color: #333;
    }
    
    .form-group .hint {
      font-size: 12px;
      color: #888;
      font-weight: normal;
    }
    
    .template-row {
      display: flex;
      gap: 10px;
    }
    
    .template-row select {
      flex: 1;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
    }
    
    .template-row button {
      padding: 12px 20px;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      white-space: nowrap;
    }
    
    .template-row button:hover {
      background: #218838;
    }
    
    input[type="text"], textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
    }
    
    input[type="text"]:focus, textarea:focus, select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    textarea {
      min-height: 250px;
      resize: vertical;
      line-height: 1.6;
    }
    
    /* å·®ã—è¾¼ã¿ã‚¿ã‚° */
    .merge-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      padding: 10px;
      background: #fff9e6;
      border-radius: 8px;
      border: 1px solid #ffc107;
    }
    
    .merge-tags span {
      font-size: 12px;
      color: #856404;
      margin-right: 5px;
    }
    
    .merge-tag {
      padding: 4px 10px;
      background: white;
      border: 1px solid #ffc107;
      border-radius: 15px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .merge-tag:hover {
      background: #ffc107;
      color: white;
    }
    
    /* ã‚ªãƒ—ã‚·ãƒ§ãƒ³ */
    .options {
      display: flex;
      align-items: center;
      gap: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
    }
    
    .options label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .options input[type="checkbox"] {
      width: 18px;
      height: 18px;
    }
    
    /* é€ä¿¡ãƒœã‚¿ãƒ³ */
    .send-actions {
      display: flex;
      gap: 15px;
      margin-top: 10px;
    }
    
    .btn {
      padding: 15px 30px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      flex: 1;
    }
    
    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
    }
    
    .btn-secondary {
      background: #6c757d;
      color: white;
    }
    
    .btn-secondary:hover {
      background: #5a6268;
    }
    
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    /* ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç† */
    .template-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .template-card {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 15px 20px;
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 10px;
      transition: all 0.2s;
    }
    
    .template-card:hover {
      border-color: #667eea;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .template-card-info {
      flex: 1;
    }
    
    .template-card-name {
      font-weight: bold;
      font-size: 16px;
      color: #333;
      margin-bottom: 5px;
    }
    
    .template-card-subject {
      font-size: 14px;
      color: #666;
      margin-bottom: 5px;
    }
    
    .template-card-date {
      font-size: 12px;
      color: #999;
    }
    
    .template-card-actions {
      display: flex;
      gap: 8px;
    }
    
    .template-card-actions button {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn-edit {
      background: #17a2b8;
      color: white;
    }
    
    .btn-edit:hover {
      background: #138496;
    }
    
    .btn-delete {
      background: #dc3545;
      color: white;
    }
    
    .btn-delete:hover {
      background: #c82333;
    }
    
    /* ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    
    .modal-overlay.active {
      display: flex;
    }
    
    .modal {
      background: white;
      border-radius: 12px;
      width: 90%;
      max-width: 700px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    
    .modal-header {
      padding: 20px 25px;
      border-bottom: 1px solid #e9ecef;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .modal-header h2 {
      font-size: 20px;
      color: #333;
    }
    
    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #666;
    }
    
    .modal-body {
      padding: 25px;
    }
    
    .modal-footer {
      padding: 20px 25px;
      border-top: 1px solid #e9ecef;
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }
    
    /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .preview-content {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      white-space: pre-wrap;
      font-family: inherit;
      line-height: 1.6;
    }
    
    /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    
    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #e9ecef;
      border-top-color: #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* é€šçŸ¥ */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 25px;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      z-index: 2000;
      transform: translateX(120%);
      transition: transform 0.3s;
    }
    
    .notification.show {
      transform: translateX(0);
    }
    
    .notification.success {
      background: #28a745;
    }
    
    .notification.error {
      background: #dc3545;
    }
    
    /* æˆ»ã‚‹ãƒªãƒ³ã‚¯ */
    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      color: white;
      text-decoration: none;
      font-size: 14px;
      margin-bottom: 15px;
      opacity: 0.9;
    }
    
    .back-link:hover {
      opacity: 1;
      text-decoration: underline;
    }
    
    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
    @media (max-width: 900px) {
      .two-column {
        grid-template-columns: 1fr;
      }
      
      .recipient-panel {
        max-height: 300px;
      }
    }

/* ========== ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ãƒ¢ãƒ¼ãƒ€ãƒ« ========== */
.auth-overlay {
    display: flex;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    justify-content: center;
    align-items: center;
    z-index: 10000;
}

.auth-overlay.hidden {
    display: none;
}

.auth-modal {
    background: white;
    padding: 40px;
    border-radius: 16px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    text-align: center;
    max-width: 400px;
    width: 90%;
    animation: authModalIn 0.3s ease;
}

@keyframes authModalIn {
    from { opacity: 0; transform: scale(0.9) translateY(-20px); }
    to { opacity: 1; transform: scale(1) translateY(0); }
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    20%, 60% { transform: translateX(-10px); }
    40%, 80% { transform: translateX(10px); }
}

.auth-modal h2 {
    color: #4285f4;
    margin-bottom: 10px;
    font-size: 24px;
}

.auth-modal .auth-subtitle {
    color: #666;
    margin-bottom: 30px;
    font-size: 14px;
}

.auth-modal .auth-icon {
    font-size: 60px;
    margin-bottom: 20px;
}

.auth-modal input[type="password"] {
    width: 100%;
    padding: 15px;
    font-size: 18px;
    border: 2px solid #ddd;
    border-radius: 8px;
    margin-bottom: 20px;
    text-align: center;
    letter-spacing: 4px;
}

.auth-modal input[type="password"]:focus {
    outline: none;
    border-color: #4285f4;
    box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.2);
}

.auth-modal .auth-btn {
    width: 100%;
    padding: 15px;
    font-size: 16px;
    font-weight: bold;
    color: white;
    background: linear-gradient(135deg, #4285f4, #34a853);
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s;
}

.auth-modal .auth-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 20px rgba(66, 133, 244, 0.4);
}

.auth-modal .auth-btn:disabled {
    background: #ccc;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

.auth-modal .auth-error {
    color: #dc3545;
    font-size: 14px;
    margin-top: 15px;
    padding: 10px;
    background: #ffebee;
    border-radius: 6px;
    display: none;
}

.auth-modal .auth-error.show {
    display: block;
}

.auth-modal .auth-hint {
    color: #999;
    font-size: 12px;
    margin-top: 20px;
}
    
  </style>
</head>
<body>
<!-- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
<div id="authOverlay" class="auth-overlay">
    <div class="auth-modal">
        <div class="auth-icon">ğŸ”</div>
        <h2>ç®¡ç†è€…èªè¨¼</h2>
        <p class="auth-subtitle">ç®¡ç†ç”»é¢ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã«ã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå¿…è¦ã§ã™</p>
        
        <form id="authForm" onsubmit="return handleAuthSubmit(event)">
            <input type="password" id="authPassword" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›" autocomplete="current-password" required>
            <button type="submit" class="auth-btn" id="authSubmitBtn">ğŸ”“ ãƒ­ã‚°ã‚¤ãƒ³</button>
        </form>
        
        <div id="authError" class="auth-error"></div>
        
        <p class="auth-hint">â€» ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¿˜ã‚ŒãŸå ´åˆã¯ç®¡ç†è€…ã«é€£çµ¡ã—ã¦ãã ã•ã„</p>
    </div>
</div>

  <div class="container">
    <!-- æˆ»ã‚‹ãƒªãƒ³ã‚¯ -->
    <a href="CardGeneratorUI.html" class="back-link">â† ä¼šå“¡ç®¡ç†ç”»é¢ã«æˆ»ã‚‹</a>
    
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="header">
      <h1>ğŸ“§ ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚·ã‚¹ãƒ†ãƒ </h1>
      <p>ä¼šå“¡ã¸ã®ãƒ¡ãƒ¼ãƒ«é€ä¿¡ãƒ»ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç†</p>
    </div>
    
    <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <div class="nav-tabs">
      <button class="nav-tab active" onclick="switchTab('compose')">âœ‰ï¸ ãƒ¡ãƒ¼ãƒ«ä½œæˆ</button>
      <button class="nav-tab" onclick="switchTab('templates')">ğŸ“ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç†</button>
    </div>
    
    <!-- ãƒ¡ãƒ¼ãƒ«ä½œæˆã‚¿ãƒ– -->
    <div id="tab-compose" class="card active">
      <div class="two-column">
        <!-- å·¦: å®›å…ˆé¸æŠ -->
        <div class="recipient-panel">
          <div class="section-title">ğŸ‘¥ å®›å…ˆé¸æŠ</div>
          
          <div class="filter-section">
            <label>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã§çµã‚Šè¾¼ã¿</label>
            <select id="status-filter" onchange="loadMembers()">
              <option value="ALL">ã™ã¹ã¦ã®ä¼šå“¡</option>
              <option value="ACTIVE">æœ‰åŠ¹ãªä¼šå“¡ã®ã¿</option>
              <option value="INACTIVE">ç„¡åŠ¹ãªä¼šå“¡ã®ã¿</option>
            </select>
          </div>
          
          <div class="recipient-list" id="recipient-list">
            <div class="loading">
              <div class="spinner"></div>
              <div>ä¼šå“¡ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
            </div>
          </div>
          
          <div class="selection-controls">
            <button onclick="selectAll()">å…¨é¸æŠ</button>
            <button onclick="deselectAll()">å…¨è§£é™¤</button>
          </div>
          
          <div class="selected-count">
            <span id="selected-count">0</span> ä»¶é¸æŠä¸­
          </div>
        </div>
        
        <!-- å³: ãƒ¡ãƒ¼ãƒ«ä½œæˆ -->
        <div class="compose-panel">
          <div class="section-title">ğŸ“ ãƒ¡ãƒ¼ãƒ«å†…å®¹</div>
          
          <!-- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠ -->
          <div class="form-group">
            <label>ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</label>
            <div class="template-row">
              <select id="template-select">
                <option value="">-- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸æŠ --</option>
              </select>
              <button onclick="applyTemplate()">ğŸ“¥ æŒ¿å…¥</button>
            </div>
          </div>
          
          <!-- ä»¶å -->
          <div class="form-group">
            <label>ä»¶å <span class="hint">â€»å¿…é ˆ</span></label>
            <input type="text" id="email-subject" placeholder="ãƒ¡ãƒ¼ãƒ«ã®ä»¶åã‚’å…¥åŠ›">
          </div>
          
          <!-- å·®ã—è¾¼ã¿ã‚¿ã‚° -->
          <div class="merge-tags">
            <span>ğŸ“Œ å·®ã—è¾¼ã¿ã‚¿ã‚°ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§æŒ¿å…¥ï¼‰:</span>
            <button class="merge-tag" onclick="insertTag('{ä¼šå“¡ç•ªå·}')">{ä¼šå“¡ç•ªå·}</button>
            <button class="merge-tag" onclick="insertTag('{åº—å}')">{åº—å}</button>
            <button class="merge-tag" onclick="insertTag('{ä»£è¡¨è€…å}')">{ä»£è¡¨è€…å}</button>
            <button class="merge-tag" onclick="insertTag('{ç€ç”¨è€…å}')">{ç€ç”¨è€…å}</button>
            <button class="merge-tag" onclick="insertTag('{æœ‰åŠ¹æœŸé™}')">{æœ‰åŠ¹æœŸé™}</button>
          </div>
          
          <!-- æœ¬æ–‡ -->
          <div class="form-group">
            <label>æœ¬æ–‡ <span class="hint">â€»å¿…é ˆ</span></label>
            <textarea id="email-body" placeholder="ãƒ¡ãƒ¼ãƒ«ã®æœ¬æ–‡ã‚’å…¥åŠ›"></textarea>
          </div>
          
          <!-- ã‚ªãƒ—ã‚·ãƒ§ãƒ³ -->
          <div class="options">
            <label>
              <input type="checkbox" id="bcc-admin" checked>
              ç®¡ç†è€…ã«BCCã§é€ä¿¡ï¼ˆé€ä¿¡å±¥æ­´ã¨ã—ã¦ï¼‰
            </label>
          </div>
          
          <!-- é€ä¿¡ãƒœã‚¿ãƒ³ -->
          <div class="send-actions">
            <button class="btn btn-secondary" onclick="previewEmail()">ğŸ‘ï¸ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
            <button class="btn btn-primary" id="btn-send" onclick="sendEmail()">
              ğŸ“¤ ãƒ¡ãƒ¼ãƒ«é€ä¿¡
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç†ã‚¿ãƒ– -->
    <div id="tab-templates" class="card">
      <div class="section-title" style="justify-content: space-between;">
        <span>ğŸ“ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¸€è¦§</span>
        <button class="btn btn-primary" style="padding: 10px 20px; font-size: 14px;" onclick="openTemplateModal()">
          â• æ–°è¦ä½œæˆ
        </button>
      </div>
      
      <div class="template-list" id="template-list">
        <div class="loading">
          <div class="spinner"></div>
          <div>ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal-overlay" id="template-modal">
    <div class="modal">
      <div class="modal-header">
        <h2 id="modal-title">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç·¨é›†</h2>
        <button class="modal-close" onclick="closeTemplateModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="edit-template-id">
        
        <div class="form-group" style="margin-bottom: 15px;">
          <label>ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå</label>
          <input type="text" id="edit-template-name" placeholder="ä¾‹: ã€åŸºæœ¬ã€‘è²·å‡ºäººç« ç™ºè¡Œã®ãŠçŸ¥ã‚‰ã›">
        </div>
        
        <div class="form-group" style="margin-bottom: 15px;">
          <label>ä»¶å</label>
          <input type="text" id="edit-template-subject" placeholder="ãƒ¡ãƒ¼ãƒ«ã®ä»¶å">
        </div>
        
        <div class="merge-tags" style="margin-bottom: 15px;">
          <span>ğŸ“Œ å·®ã—è¾¼ã¿ã‚¿ã‚°:</span>
          <button class="merge-tag" onclick="insertTagToModal('{ä¼šå“¡ç•ªå·}')">{ä¼šå“¡ç•ªå·}</button>
          <button class="merge-tag" onclick="insertTagToModal('{åº—å}')">{åº—å}</button>
          <button class="merge-tag" onclick="insertTagToModal('{ä»£è¡¨è€…å}')">{ä»£è¡¨è€…å}</button>
          <button class="merge-tag" onclick="insertTagToModal('{ç€ç”¨è€…å}')">{ç€ç”¨è€…å}</button>
          <button class="merge-tag" onclick="insertTagToModal('{æœ‰åŠ¹æœŸé™}')">{æœ‰åŠ¹æœŸé™}</button>
        </div>
        
        <div class="form-group">
          <label>æœ¬æ–‡</label>
          <textarea id="edit-template-body" style="min-height: 200px;" placeholder="ãƒ¡ãƒ¼ãƒ«ã®æœ¬æ–‡"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeTemplateModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn btn-primary" onclick="saveTemplate()">ğŸ’¾ ä¿å­˜</button>
      </div>
    </div>
  </div>
  
  <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal-overlay" id="preview-modal">
    <div class="modal">
      <div class="modal-header">
        <h2>ğŸ“§ ãƒ¡ãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h2>
        <button class="modal-close" onclick="closePreviewModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <div class="form-group" style="margin-bottom: 15px;">
          <label>å®›å…ˆï¼ˆæœ€åˆã®1ä»¶ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰</label>
          <div id="preview-to" style="padding: 10px; background: #f8f9fa; border-radius: 6px;"></div>
        </div>
        <div class="form-group" style="margin-bottom: 15px;">
          <label>ä»¶å</label>
          <div id="preview-subject" style="padding: 10px; background: #f8f9fa; border-radius: 6px; font-weight: bold;"></div>
        </div>
        <div class="form-group">
          <label>æœ¬æ–‡</label>
          <div id="preview-body" class="preview-content"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closePreviewModal()">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>
  
  <!-- é€šçŸ¥ -->
  <div class="notification" id="notification"></div>
  
  <script>
    // APIè¨­å®š
    const API_URL = 'https://script.google.com/macros/s/AKfycbwbbyZoRzhWu8Ft5xVvyI1LJc7_RLZaeLwVGapXnlYIIJBUSlgJXQTzofwuLl5nux43kg/exec';
    
    // ========== ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ã‚·ã‚¹ãƒ†ãƒ  ========== //
    
    const AUTH_STORAGE_KEY = 'ota_admin_auth';
    const AUTH_EXPIRY_HOURS = 24;
    
    function checkAuthentication() {
        const authData = localStorage.getItem(AUTH_STORAGE_KEY);
        
        if (!authData) {
            showAuthModal();
            return false;
        }
        
        try {
            const { token, expiresAt } = JSON.parse(authData);
            
            if (Date.now() > expiresAt) {
                localStorage.removeItem(AUTH_STORAGE_KEY);
                showAuthModal();
                return false;
            }
            
            hideAuthModal();
            return true;
            
        } catch (e) {
            localStorage.removeItem(AUTH_STORAGE_KEY);
            showAuthModal();
            return false;
        }
    }
    
    function showAuthModal() {
        document.getElementById('authOverlay').classList.remove('hidden');
        document.getElementById('authPassword').focus();
        document.body.style.overflow = 'hidden';
    }
    
    function hideAuthModal() {
        document.getElementById('authOverlay').classList.add('hidden');
        document.body.style.overflow = '';
    }
    
    async function handleAuthSubmit(event) {
        event.preventDefault();
        
        const password = document.getElementById('authPassword').value;
        const submitBtn = document.getElementById('authSubmitBtn');
        const errorDiv = document.getElementById('authError');
        
        if (!password) {
            showAuthError('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return false;
        }
        
        submitBtn.disabled = true;
        submitBtn.textContent = 'ğŸ”„ èªè¨¼ä¸­...';
        errorDiv.classList.remove('show');
        
        try {
            // IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—
            let clientIP = '';
            try {
                const ipResponse = await fetch('https://api.ipify.org?format=json');
                const ipData = await ipResponse.json();
                clientIP = ipData.ip;
            } catch (e) { }
            
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({
                    action: 'verifyAdminPassword',
                    password: password,
                    clientIP: clientIP
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                const authData = {
                    token: result.token,
                    expiresAt: result.expiresAt
                };
                localStorage.setItem(AUTH_STORAGE_KEY, JSON.stringify(authData));
                
                hideAuthModal();
                
                if (typeof initializePage === 'function') {
                    initializePage();
                }
                
            } else {
                showAuthError(result.error || 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
            }
            
        } catch (error) {
            console.error('èªè¨¼ã‚¨ãƒ©ãƒ¼:', error);
            showAuthError('èªè¨¼ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'ğŸ”“ ãƒ­ã‚°ã‚¤ãƒ³';
        }
        
        return false;
    }
    
    function showAuthError(message) {
        const errorDiv = document.getElementById('authError');
        errorDiv.textContent = message;
        errorDiv.classList.add('show');
        
        const passwordInput = document.getElementById('authPassword');
        passwordInput.style.animation = 'none';
        passwordInput.offsetHeight;
        passwordInput.style.animation = 'shake 0.5s';
        passwordInput.select();
    }
    
    function logout() {
        localStorage.removeItem(AUTH_STORAGE_KEY);
        showAuthModal();
    }
    
    // ãƒ‡ãƒ¼ã‚¿ä¿æŒ
    let members = [];
    let templates = [];
    let selectedMembers = new Set();
    
    // åˆæœŸåŒ–
    function initializePage() {
      loadMembers();
      loadTemplates();
    }
    
    document.addEventListener('DOMContentLoaded', () => {
      // èªè¨¼ãƒã‚§ãƒƒã‚¯
      if (!checkAuthentication()) {
        return;
      }
      initializePage();
    });
    
    // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
    function switchTab(tabName) {
      document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.card').forEach(card => card.classList.remove('active'));
      
      document.querySelector(`.nav-tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
      document.getElementById(`tab-${tabName}`).classList.add('active');
    }
    
    // ä¼šå“¡ãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿
    async function loadMembers() {
      const status = document.getElementById('status-filter').value;
      const listEl = document.getElementById('recipient-list');
      
      listEl.innerHTML = '<div class="loading"><div class="spinner"></div><div>èª­ã¿è¾¼ã¿ä¸­...</div></div>';
      
      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          body: JSON.stringify({
            action: 'getMembersByStatus',
            status: status
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          members = result.members;
          members.sort((a, b) => b.rowNumber - a.rowNumber);  // è¿½åŠ 
          renderMemberList();
        } else {
          listEl.innerHTML = '<div class="loading">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</div>';
        }
      } catch (error) {
        listEl.innerHTML = '<div class="loading">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + error.message + '</div>';
      }
    }
    
    // ä¼šå“¡ãƒªã‚¹ãƒˆæç”»
    function renderMemberList() {
      const listEl = document.getElementById('recipient-list');
      
      if (members.length === 0) {
        listEl.innerHTML = '<div class="loading">ä¼šå“¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>';
        return;
      }
      
      listEl.innerHTML = members.map(member => `
        <label class="recipient-item">
          <input type="checkbox" 
                 value="${member.rowNumber}" 
                 ${selectedMembers.has(member.rowNumber) ? 'checked' : ''}
                 onchange="toggleMember(${member.rowNumber})">
          <div class="recipient-info">
            <div class="recipient-name">${escapeHtml(member.storeName)} - ${escapeHtml(member.wearerName || member.representativeName)}</div>
            <div class="recipient-detail">${escapeHtml(member.memberId)} | ${escapeHtml(member.email)}</div>
          </div>
          <span class="recipient-status ${member.status === 'ACTIVE' ? 'status-active' : 'status-inactive'}">
            ${member.status === 'ACTIVE' ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹'}
          </span>
        </label>
      `).join('');
      
      updateSelectedCount();
    }
    
    // ä¼šå“¡é¸æŠãƒˆã‚°ãƒ«
    function toggleMember(rowNumber) {
      if (selectedMembers.has(rowNumber)) {
        selectedMembers.delete(rowNumber);
      } else {
        selectedMembers.add(rowNumber);
      }
      updateSelectedCount();
    }
    
    // å…¨é¸æŠ
    function selectAll() {
      members.forEach(m => selectedMembers.add(m.rowNumber));
      renderMemberList();
    }
    
    // å…¨è§£é™¤
    function deselectAll() {
      selectedMembers.clear();
      renderMemberList();
    }
    
    // é¸æŠæ•°æ›´æ–°
    function updateSelectedCount() {
      document.getElementById('selected-count').textContent = selectedMembers.size;
    }
    
    // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆèª­ã¿è¾¼ã¿
    async function loadTemplates() {
      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          body: JSON.stringify({ action: 'getEmailTemplates' })
        });
        
        const result = await response.json();
        
        if (result.success) {
          templates = result.templates;
          renderTemplateSelect();
          renderTemplateList();
        }
      } catch (error) {
        console.error('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      }
    }
    
    // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠè‚¢æç”»
    function renderTemplateSelect() {
      const selectEl = document.getElementById('template-select');
      selectEl.innerHTML = '<option value="">-- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸æŠ --</option>' +
        templates.map(t => `<option value="${t.id}">${escapeHtml(t.name)}</option>`).join('');
    }
    
    // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¸€è¦§æç”»
    function renderTemplateList() {
      const listEl = document.getElementById('template-list');
      
      if (templates.length === 0) {
        listEl.innerHTML = '<div class="loading">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }
      
      listEl.innerHTML = templates.map(t => `
        <div class="template-card">
          <div class="template-card-info">
            <div class="template-card-name">${escapeHtml(t.name)}</div>
            <div class="template-card-subject">ä»¶å: ${escapeHtml(t.subject)}</div>
            <div class="template-card-date">æ›´æ–°: ${t.updatedAt}</div>
          </div>
          <div class="template-card-actions">
            <button class="btn-edit" onclick="editTemplate('${t.id}')">âœï¸ ç·¨é›†</button>
            <button class="btn-delete" onclick="deleteTemplate('${t.id}')">ğŸ—‘ï¸ å‰Šé™¤</button>
          </div>
        </div>
      `).join('');
    }
    
    // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé©ç”¨
    function applyTemplate() {
      const templateId = document.getElementById('template-select').value;
      if (!templateId) {
        showNotification('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
        return;
      }
      
      const template = templates.find(t => t.id === templateId);
      if (template) {
        document.getElementById('email-subject').value = template.subject;
        document.getElementById('email-body').value = template.body;
        showNotification('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’æŒ¿å…¥ã—ã¾ã—ãŸ', 'success');
      }
    }
    
    // å·®ã—è¾¼ã¿ã‚¿ã‚°æŒ¿å…¥
    function insertTag(tag) {
      const textarea = document.getElementById('email-body');
      const start = textarea.selectionStart;
      const end = textarea.selectionEnd;
      const text = textarea.value;
      textarea.value = text.substring(0, start) + tag + text.substring(end);
      textarea.focus();
      textarea.selectionStart = textarea.selectionEnd = start + tag.length;
    }
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ã‚¿ã‚°æŒ¿å…¥
    function insertTagToModal(tag) {
      const textarea = document.getElementById('edit-template-body');
      const start = textarea.selectionStart;
      const end = textarea.selectionEnd;
      const text = textarea.value;
      textarea.value = text.substring(0, start) + tag + text.substring(end);
      textarea.focus();
      textarea.selectionStart = textarea.selectionEnd = start + tag.length;
    }
    
    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
    function previewEmail() {
      if (selectedMembers.size === 0) {
        showNotification('å®›å…ˆã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
        return;
      }
      
      const subject = document.getElementById('email-subject').value;
      const body = document.getElementById('email-body').value;
      
      if (!subject || !body) {
        showNotification('ä»¶åã¨æœ¬æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
        return;
      }
      
      // æœ€åˆã®é¸æŠä¼šå“¡ã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
      const firstRowNumber = Array.from(selectedMembers)[0];
      const member = members.find(m => m.rowNumber === firstRowNumber);
      
      if (member) {
        const previewSubject = replaceVariables(subject, member);
        const previewBody = replaceVariables(body, member);
        
        document.getElementById('preview-to').textContent = `${member.storeName} <${member.email}>`;
        document.getElementById('preview-subject').textContent = previewSubject;
        document.getElementById('preview-body').textContent = previewBody;
        
        document.getElementById('preview-modal').classList.add('active');
      }
    }
    
    // å¤‰æ•°ç½®æ›ï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ï¼‰
    function replaceVariables(text, member) {
      return text
        .replace(/\{ä¼šå“¡ç•ªå·\}/g, member.memberId || '')
        .replace(/\{åº—å\}/g, member.storeName || '')
        .replace(/\{ä»£è¡¨è€…å\}/g, member.representativeName || '')
        .replace(/\{ç€ç”¨è€…å\}/g, member.wearerName || '')
        .replace(/\{æœ‰åŠ¹æœŸé™\}/g, member.expiresAt || '')
        .replace(/\{ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹\}/g, member.status || '');
    }
    
    // ãƒ¡ãƒ¼ãƒ«é€ä¿¡
    async function sendEmail() {
      if (selectedMembers.size === 0) {
        showNotification('å®›å…ˆã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
        return;
      }
      
      const subject = document.getElementById('email-subject').value;
      const body = document.getElementById('email-body').value;
      const bccToAdmin = document.getElementById('bcc-admin').checked;
      
      if (!subject || !body) {
        showNotification('ä»¶åã¨æœ¬æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
        return;
      }
      
      if (!confirm(`${selectedMembers.size}ä»¶ã®å®›å…ˆã«ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) {
        return;
      }
      
      const btn = document.getElementById('btn-send');
      btn.disabled = true;
      btn.innerHTML = 'ğŸ“¤ é€ä¿¡ä¸­...';
      
      try {
        const recipients = Array.from(selectedMembers).map(rowNumber => {
          const member = members.find(m => m.rowNumber === rowNumber);
          return {
            rowNumber: rowNumber,
            email: member ? member.email : ''
          };
        });
        
        const response = await fetch(API_URL, {
          method: 'POST',
          body: JSON.stringify({
            action: 'sendBulkEmail',
            recipients: recipients,
            subject: subject,
            body: body,
            bccToAdmin: bccToAdmin
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          showNotification(result.message, 'success');
          deselectAll();
        } else {
          showNotification('é€ä¿¡ã‚¨ãƒ©ãƒ¼: ' + result.error, 'error');
        }
      } catch (error) {
        showNotification('é€ä¿¡ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = 'ğŸ“¤ ãƒ¡ãƒ¼ãƒ«é€ä¿¡';
      }
    }
    
    // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«
    function openTemplateModal(id = null) {
      document.getElementById('modal-title').textContent = id ? 'ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç·¨é›†' : 'æ–°è¦ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½œæˆ';
      
      if (id) {
        const template = templates.find(t => t.id === id);
        if (template) {
          document.getElementById('edit-template-id').value = template.id;
          document.getElementById('edit-template-name').value = template.name;
          document.getElementById('edit-template-subject').value = template.subject;
          document.getElementById('edit-template-body').value = template.body;
        }
      } else {
        document.getElementById('edit-template-id').value = '';
        document.getElementById('edit-template-name').value = '';
        document.getElementById('edit-template-subject').value = '';
        document.getElementById('edit-template-body').value = '';
      }
      
      document.getElementById('template-modal').classList.add('active');
    }
    
    function closeTemplateModal() {
      document.getElementById('template-modal').classList.remove('active');
    }
    
    function editTemplate(id) {
      openTemplateModal(id);
    }
    
    // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¿å­˜
    async function saveTemplate() {
      const id = document.getElementById('edit-template-id').value;
      const name = document.getElementById('edit-template-name').value;
      const subject = document.getElementById('edit-template-subject').value;
      const body = document.getElementById('edit-template-body').value;
      
      if (!name || !subject || !body) {
        showNotification('ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
        return;
      }
      
      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          body: JSON.stringify({
            action: 'saveEmailTemplate',
            id: id || null,
            name: name,
            subject: subject,
            body: body
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          showNotification(result.message, 'success');
          closeTemplateModal();
          loadTemplates();
        } else {
          showNotification('ä¿å­˜ã‚¨ãƒ©ãƒ¼: ' + result.error, 'error');
        }
      } catch (error) {
        showNotification('ä¿å­˜ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
      }
    }
    
    // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå‰Šé™¤
    async function deleteTemplate(id) {
      if (!confirm('ã“ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
        return;
      }
      
      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          body: JSON.stringify({
            action: 'deleteEmailTemplate',
            id: id
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          showNotification(result.message, 'success');
          loadTemplates();
        } else {
          showNotification('å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ' + result.error, 'error');
        }
      } catch (error) {
        showNotification('å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
      }
    }
    
    function closePreviewModal() {
      document.getElementById('preview-modal').classList.remove('active');
    }
    
    // é€šçŸ¥è¡¨ç¤º
    function showNotification(message, type) {
      const el = document.getElementById('notification');
      el.textContent = message;
      el.className = 'notification ' + type + ' show';
      
      setTimeout(() => {
        el.classList.remove('show');
      }, 3000);
    }
    
    // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>
