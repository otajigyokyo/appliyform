<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¼šå“¡è©³ç´° - è²·å‡ºäººç« ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', 'Noto Sans JP', sans-serif;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }
    
    /* ========== ãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨åˆ† ========== */
    .member-header {
      display: flex;
      gap: 25px;
      padding-bottom: 25px;
      border-bottom: 2px solid #667eea;
      margin-bottom: 25px;
    }
    
    .photo-container {
      flex-shrink: 0;
    }
    
    .member-photo {
      width: 100px;
      height: 130px;
      object-fit: cover;
      border-radius: 8px;
      border: 3px solid #667eea;
      background: #f0f0f0;
    }
    
    .no-photo {
      width: 100px;
      height: 130px;
      border-radius: 8px;
      border: 3px solid #ddd;
      background: #f5f5f5;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #999;
      font-size: 12px;
    }
    
    .header-info {
      flex: 1;
    }
    
    .member-id-row {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 10px;
    }
    
    .member-id {
      font-size: 28px;
      font-weight: bold;
      color: #667eea;
    }
    
    .status-badge {
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: bold;
    }
    
    .status-active {
      background: #d4edda;
      color: #155724;
    }
    
    .status-inactive {
      background: #f8d7da;
      color: #721c24;
    }
    
    .status-pending {
      background: #fff3cd;
      color: #856404;
    }
    
    .store-name {
      font-size: 22px;
      color: #333;
      margin-bottom: 5px;
    }
    
    .wearer-name {
      font-size: 18px;
      color: #555;
    }
    
    /* ========== æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ ========== */
    .info-section {
      margin-bottom: 25px;
    }
    
    .info-section h2 {
      font-size: 16px;
      color: #667eea;
      padding: 10px 15px;
      background: #f8f9fa;
      border-left: 4px solid #667eea;
      margin-bottom: 15px;
    }
    
    .info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }
    
    .info-item {
      padding: 12px 15px;
      background: #fafafa;
      border-radius: 6px;
      border: 1px solid #e0e0e0;
    }
    
    .info-item.full-width {
      grid-column: 1 / -1;
    }
    
    .info-label {
      font-size: 12px;
      color: #888;
      margin-bottom: 5px;
    }
    
    .info-value {
      font-size: 15px;
      color: #333;
      word-break: break-all;
    }
    
    .info-value.large {
      font-size: 18px;
      font-weight: bold;
      color: #667eea;
    }
    
    /* ========== å°åˆ·å›æ•°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ ========== */
    .print-counts {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 25px;
    }
    
    .print-count-box {
      text-align: center;
      padding: 20px;
      border-radius: 10px;
      border: 2px solid;
    }
    
    .print-count-box.card {
      border-color: #667eea;
      background: #f0f4ff;
    }
    
    .print-count-box.app {
      border-color: #28a745;
      background: #f0fff4;
    }
    
    .print-count-label {
      font-size: 14px;
      color: #666;
      margin-bottom: 10px;
    }
    
    .print-count-value {
      font-size: 36px;
      font-weight: bold;
    }
    
    .print-count-box.card .print-count-value {
      color: #667eea;
    }
    
    .print-count-box.app .print-count-value {
      color: #28a745;
    }
    
    .print-count-unit {
      font-size: 14px;
      color: #666;
    }
    
    /* ========== QRã‚³ãƒ¼ãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ ========== */
    .qr-section {
      text-align: center;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 10px;
      margin-bottom: 25px;
    }
    
    .qr-section h3 {
      font-size: 14px;
      color: #666;
      margin-bottom: 15px;
    }
    
    .qr-image {
      width: 150px;
      height: 150px;
      border: 2px solid #ddd;
      border-radius: 8px;
      background: white;
    }
    
    .no-qr {
      width: 150px;
      height: 150px;
      margin: 0 auto;
      border: 2px dashed #ddd;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #999;
      font-size: 12px;
      background: white;
    }
    
    /* ========== ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ ========== */
    .action-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 15px;
      margin-top: 25px;
      padding-top: 25px;
      border-top: 2px solid #e0e0e0;
    }
    
    .btn {
      padding: 15px 20px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .btn-card {
      background: #667eea;
      color: white;
    }
    
    .btn-card:hover:not(:disabled) {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }
    
    .btn-application {
      background: #28a745;
      color: white;
    }
    
    .btn-application:hover:not(:disabled) {
      background: #218838;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
    }
    
    .btn-close {
      background: #6c757d;
      color: white;
    }
    
    .btn-close:hover {
      background: #545b62;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
    }
    
    .btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    
    /* ========== ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ ========== */
    .message {
      padding: 15px;
      margin: 15px 0;
      border-radius: 6px;
      display: none;
    }
    
    .message.success {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }
    
    .message.error {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }
    
    .result-link {
      display: block;
      margin-top: 10px;
      padding: 10px;
      background: #e7f3ff;
      border-radius: 6px;
      text-align: center;
    }
    
    .result-link a {
      color: #0066cc;
      text-decoration: none;
      font-weight: bold;
    }
    
    .result-link a:hover {
      text-decoration: underline;
    }
    
    /* ========== ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° ========== */
    .loading {
      text-align: center;
      padding: 60px 20px;
    }
    
    .spinner {
      display: inline-block;
      width: 50px;
      height: 50px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading-text {
      margin-top: 15px;
      color: #666;
      font-size: 16px;
    }
    
    /* ========== ã‚¨ãƒ©ãƒ¼è¡¨ç¤º ========== */
    .error-container {
      text-align: center;
      padding: 60px 20px;
    }
    
    .error-icon {
      font-size: 60px;
      margin-bottom: 20px;
    }
    
    .error-title {
      font-size: 20px;
      color: #721c24;
      margin-bottom: 10px;
    }
    
    .error-message {
      color: #666;
      margin-bottom: 20px;
    }
    
    /* ========== ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– ========== */
    @media (max-width: 600px) {
      body {
        padding: 10px;
      }
      
      .container {
        padding: 20px;
      }
      
      .member-header {
        flex-direction: column;
        align-items: center;
        text-align: center;
      }
      
      .member-id-row {
        flex-direction: column;
        gap: 10px;
      }
      
      .member-id {
        font-size: 24px;
      }
      
      .store-name {
        font-size: 18px;
      }
      
      .wearer-name {
        font-size: 16px;
      }
      
      .info-grid {
        grid-template-columns: 1fr;
      }
      
      .info-item.full-width {
        grid-column: 1;
      }
      
      .print-counts {
        grid-template-columns: 1fr;
      }
      
      .action-buttons {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º -->
    <div class="loading" id="loading">
      <div class="spinner"></div>
      <div class="loading-text">ä¼šå“¡æƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>
    
    <!-- ã‚¨ãƒ©ãƒ¼è¡¨ç¤º -->
    <div class="error-container" id="errorContainer" style="display: none;">
      <div class="error-icon">âš ï¸</div>
      <div class="error-title">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</div>
      <div class="error-message" id="errorMessage">ä¼šå“¡æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>
      <button class="btn btn-close" onclick="window.close()">âœ• é–‰ã˜ã‚‹</button>
    </div>
    
    <!-- ä¼šå“¡è©³ç´°ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <div id="memberContent" style="display: none;">
      <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
      <div class="member-header">
        <div class="photo-container">
          <div class="no-photo" id="photoPlaceholder">å†™çœŸãªã—</div>
          <img class="member-photo" id="memberPhoto" style="display: none;" alt="ä¼šå“¡å†™çœŸ">
        </div>
        <div class="header-info">
          <div class="member-id-row">
            <span class="member-id" id="memberId">-</span>
            <span class="status-badge status-pending" id="statusBadge">-</span>
          </div>
          <div class="store-name" id="storeName">-</div>
          <div class="wearer-name" id="wearerName">-</div>
        </div>
      </div>
      
      <!-- åŸºæœ¬æƒ…å ± -->
      <div class="info-section">
        <h2>ğŸ“‹ åŸºæœ¬æƒ…å ±</h2>
        <div class="info-grid">
          <div class="info-item">
            <div class="info-label">ä»£è¡¨è€…å</div>
            <div class="info-value" id="representativeName">-</div>
          </div>
          <div class="info-item">
            <div class="info-label">æ¥­ç¨®</div>
            <div class="info-value" id="businessType">-</div>
          </div>
          <div class="info-item full-width">
            <div class="info-label">ä½æ‰€</div>
            <div class="info-value" id="address">-</div>
          </div>
          <div class="info-item">
            <div class="info-label">é›»è©±ç•ªå·</div>
            <div class="info-value" id="phone">-</div>
          </div>
          <div class="info-item">
            <div class="info-label">FAXç•ªå·</div>
            <div class="info-value" id="fax">-</div>
          </div>
          <div class="info-item full-width">
            <div class="info-label">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</div>
            <div class="info-value" id="email">-</div>
          </div>
        </div>
      </div>
      
      <!-- è³‡æ ¼æƒ…å ± -->
      <div class="info-section">
        <h2>ğŸ« è³‡æ ¼æƒ…å ±</h2>
        <div class="info-grid">
          <div class="info-item">
            <div class="info-label">ç™»éŒ²æ—¥</div>
            <div class="info-value" id="createdAt">-</div>
          </div>
          <div class="info-item">
            <div class="info-label">æœ‰åŠ¹æœŸé™</div>
            <div class="info-value large" id="expiresAt">-</div>
          </div>
        </div>
      </div>
      
      <!-- å°åˆ·å›æ•° -->
      <div class="print-counts">
        <div class="print-count-box card">
          <div class="print-count-label">ğŸ« ã‚«ãƒ¼ãƒ‰å°åˆ·å›æ•°</div>
          <div class="print-count-value" id="cardPrintCount">0</div>
          <div class="print-count-unit">å›</div>
        </div>
        <div class="print-count-box app">
          <div class="print-count-label">ğŸ“‹ ç”³è«‹æ›¸å°åˆ·å›æ•°</div>
          <div class="print-count-value" id="appPrintCount">0</div>
          <div class="print-count-unit">å›</div>
        </div>
      </div>
      
      <!-- QRã‚³ãƒ¼ãƒ‰ -->
      <div class="qr-section">
        <h3>ğŸ“± èªè¨¼ç”¨QRã‚³ãƒ¼ãƒ‰</h3>
        <div class="no-qr" id="qrPlaceholder">QRã‚³ãƒ¼ãƒ‰ãªã—</div>
        <img class="qr-image" id="qrImage" style="display: none;" alt="QRã‚³ãƒ¼ãƒ‰">
      </div>
      
      <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
      <div class="message" id="message"></div>
      
      <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
      <div class="action-buttons">
        <button class="btn btn-card" id="btnCard" onclick="generateCard()">
          ğŸ« ã‚«ãƒ¼ãƒ‰ç”Ÿæˆ
        </button>
        <button class="btn btn-application" id="btnApplication" onclick="generateApplication()">
          ğŸ“‹ ç”³è«‹æ›¸ç”Ÿæˆ
        </button>
        <button class="btn btn-close" onclick="window.close()">
          âœ• é–‰ã˜ã‚‹
        </button>
      </div>
    </div>
  </div>
  
  <script>
    // â˜… GAS API URL
    const API_URL = 'https://script.google.com/macros/s/AKfycbwbbyZoRzhWu8Ft5xVvyI1LJc7_RLZaeLwVGapXnlYIIJBUSlgJXQTzofwuLl5nux43kg/exec';
    
    // ç¾åœ¨ã®ä¼šå“¡ãƒ‡ãƒ¼ã‚¿
    let memberData = null;
    let rowNumber = null;
    
    // ========== åˆæœŸåŒ– ========== //
    window.onload = function() {
      // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å–å¾—
      const params = new URLSearchParams(window.location.search);
      rowNumber = params.get('row');
      const memberId = params.get('member_id');
      
      if (!rowNumber && !memberId) {
        showError('ä¼šå“¡IDã¾ãŸã¯è¡Œç•ªå·ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
        return;
      }
      
      // ä¼šå“¡è©³ç´°ã‚’å–å¾—
      loadMemberDetail(rowNumber, memberId);
    };
    
    // ========== APIå‘¼ã³å‡ºã— ========== //
    async function callApi(action, data = {}) {
      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'text/plain',
          },
          body: JSON.stringify({ action, ...data })
        });
        return await response.json();
      } catch (error) {
        console.error('APIå‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼:', error);
        throw error;
      }
    }
    
    // ========== ä¼šå“¡è©³ç´°å–å¾— ========== //
    async function loadMemberDetail(row, memberId) {
      try {
        const params = {};
        if (row) params.rowNumber = parseInt(row);
        if (memberId) params.memberId = memberId;
        
        const result = await callApi('getMemberDetail', params);
        
        if (result.success) {
          memberData = result.member;
          rowNumber = result.member.rowNumber;
          displayMemberDetail(result.member);
        } else {
          showError(result.error || 'ä¼šå“¡æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      } catch (error) {
        showError('é€šä¿¡ã‚¨ãƒ©ãƒ¼: ' + error.message);
      }
    }
    
    // ========== ä¼šå“¡æƒ…å ±è¡¨ç¤º ========== //
    function displayMemberDetail(member) {
      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°éè¡¨ç¤ºã€ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¡¨ç¤º
      document.getElementById('loading').style.display = 'none';
      document.getElementById('memberContent').style.display = 'block';
      
      // å†™çœŸ
      if (member.photoUrl) {
        document.getElementById('memberPhoto').src = member.photoUrl;
        document.getElementById('memberPhoto').style.display = 'block';
        document.getElementById('photoPlaceholder').style.display = 'none';
      }
      
      // ãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ±
      document.getElementById('memberId').textContent = member.memberId || '-';
      document.getElementById('storeName').textContent = member.storeName || '-';
      document.getElementById('wearerName').textContent = member.wearerName || '-';
      
      // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒƒã‚¸
      const statusBadge = document.getElementById('statusBadge');
      const status = (member.status || '').toUpperCase();
      if (status === 'ACTIVE') {
        statusBadge.textContent = 'æœ‰åŠ¹';
        statusBadge.className = 'status-badge status-active';
      } else if (status === 'INACTIVE') {
        statusBadge.textContent = 'ç„¡åŠ¹';
        statusBadge.className = 'status-badge status-inactive';
      } else {
        statusBadge.textContent = member.status || 'æœªè¨­å®š';
        statusBadge.className = 'status-badge status-pending';
      }
      
      // åŸºæœ¬æƒ…å ±
      document.getElementById('representativeName').textContent = member.representativeName || '-';
      document.getElementById('businessType').textContent = member.businessType || '-';
      document.getElementById('address').textContent = member.address || '-';
      document.getElementById('phone').textContent = member.phone || '-';
      document.getElementById('fax').textContent = member.fax || '-';
      document.getElementById('email').textContent = member.email || '-';
      
      // è³‡æ ¼æƒ…å ±
      document.getElementById('createdAt').textContent = member.createdAt || '-';
      document.getElementById('expiresAt').textContent = member.expiresAt || '-';
      
      // å°åˆ·å›æ•°
      document.getElementById('cardPrintCount').textContent = member.cardPrintCount || 0;
      document.getElementById('appPrintCount').textContent = member.appPrintCount || 0;
      
      // QRã‚³ãƒ¼ãƒ‰
      if (member.qrImageUrl) {
        document.getElementById('qrImage').src = member.qrImageUrl;
        document.getElementById('qrImage').style.display = 'inline-block';
        document.getElementById('qrPlaceholder').style.display = 'none';
      }
    }
    
    // ========== ã‚¨ãƒ©ãƒ¼è¡¨ç¤º ========== //
    function showError(message) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('errorMessage').textContent = message;
      document.getElementById('errorContainer').style.display = 'block';
    }
    
    // ========== ã‚«ãƒ¼ãƒ‰ç”Ÿæˆ ========== //
    async function generateCard() {
      if (!rowNumber) {
        showMessage('ä¼šå“¡æƒ…å ±ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
        return;
      }
      
      document.getElementById('btnCard').disabled = true;
      hideMessage();
      
      try {
        const result = await callApi('generateCardByRow', { rowNumber: parseInt(rowNumber) });
        
        if (result.success) {
          // å°åˆ·å›æ•°æ›´æ–°
          if (result.cardPrintCount !== undefined) {
            document.getElementById('cardPrintCount').textContent = result.cardPrintCount;
          }
          
          showSuccessWithLink(
            `âœ… ã‚«ãƒ¼ãƒ‰ç”Ÿæˆå®Œäº†ï¼ˆ${result.cardPrintCount || 1}å›ç›®ï¼‰`,
            result.slideUrl,
            'ğŸ« ã‚«ãƒ¼ãƒ‰ã‚’é–‹ã'
          );
        } else {
          showMessage('âŒ ã‚¨ãƒ©ãƒ¼: ' + result.error, 'error');
        }
      } catch (error) {
        showMessage('âŒ ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
      }
      
      document.getElementById('btnCard').disabled = false;
    }
    
    // ========== ç”³è«‹æ›¸ç”Ÿæˆ ========== //
    async function generateApplication() {
      if (!rowNumber) {
        showMessage('ä¼šå“¡æƒ…å ±ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
        return;
      }
      
      document.getElementById('btnApplication').disabled = true;
      hideMessage();
      
      try {
        const result = await callApi('generateApplicationFormByRow', { rowNumber: parseInt(rowNumber) });
        
        if (result.success) {
          // å°åˆ·å›æ•°æ›´æ–°
          if (result.appPrintCount !== undefined) {
            document.getElementById('appPrintCount').textContent = result.appPrintCount;
          }
          
          showSuccessWithLink(
            `âœ… ç”³è«‹æ›¸ç”Ÿæˆå®Œäº†ï¼ˆ${result.appPrintCount || 1}å›ç›®ï¼‰`,
            result.slideUrl,
            'ğŸ“‹ ç”³è«‹æ›¸ã‚’é–‹ã'
          );
        } else {
          showMessage('âŒ ã‚¨ãƒ©ãƒ¼: ' + result.error, 'error');
        }
      } catch (error) {
        showMessage('âŒ ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
      }
      
      document.getElementById('btnApplication').disabled = false;
    }
    
    // ========== ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º ========== //
    function showMessage(text, type) {
      const messageEl = document.getElementById('message');
      messageEl.textContent = text;
      messageEl.className = 'message ' + type;
      messageEl.style.display = 'block';
    }
    
    function hideMessage() {
      document.getElementById('message').style.display = 'none';
    }
    
    function showSuccessWithLink(text, url, linkLabel) {
      const messageEl = document.getElementById('message');
      messageEl.innerHTML = '';
      messageEl.className = 'message success';
      
      const textNode = document.createElement('div');
      textNode.textContent = text;
      messageEl.appendChild(textNode);
      
      const link = document.createElement('div');
      link.className = 'result-link';
      link.innerHTML = `<a href="${url}" target="_blank">${linkLabel}</a>`;
      messageEl.appendChild(link);
      
      messageEl.style.display = 'block';
    }
  </script>
</body>
</html>
