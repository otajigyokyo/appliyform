<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è²·å‡ºäººç« ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
  <!-- â˜… ãƒ•ã‚¡ãƒ“ã‚³ãƒ³è¿½åŠ  -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ«</text></svg>">
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ«</text></svg>">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', 'Noto Sans JP', sans-serif;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    
    .container {
      max-width: 1050px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }
    
    h1 {
      color: #667eea;
      text-align: center;
      margin-bottom: 10px;
      font-size: 26px;
    }
    
    .subtitle {
      text-align: center;
      color: #666;
      margin-bottom: 15px;
      font-size: 14px;
    }
    
    /* ========== ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒªãƒ³ã‚¯ ========== */
    .nav-links {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-bottom: 25px;
      flex-wrap: wrap;
    }
    
    .nav-link {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 10px 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      text-decoration: none;
      border-radius: 25px;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
    }
    
    .nav-link:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }
    
    .nav-link.email {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      box-shadow: 0 2px 8px rgba(245, 87, 108, 0.3);
    }
    
    .nav-link.email:hover {
      box-shadow: 0 4px 15px rgba(245, 87, 108, 0.4);
    }
    
    .nav-link.form {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      box-shadow: 0 2px 8px rgba(17, 153, 142, 0.3);
    }
    
    .nav-link.form:hover {
      box-shadow: 0 4px 15px rgba(17, 153, 142, 0.4);
    }
    
    /* ========== æ¤œç´¢ã‚»ã‚¯ã‚·ãƒ§ãƒ³ ========== */
    .search-section {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      border: 2px solid #667eea;
    }
    
    .search-section h2 {
      font-size: 16px;
      color: #333;
      margin-bottom: 15px;
    }
    
    .search-box {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .search-input {
      flex: 1;
      padding: 12px 15px;
      border: 2px solid #ddd;
      border-radius: 6px;
      font-size: 16px;
      transition: border-color 0.3s;
    }
    
    .search-input:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .search-input::placeholder {
      color: #999;
    }
    
    .btn-search {
      padding: 12px 25px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      white-space: nowrap;
    }
    
    .btn-search:hover {
      background: #5568d3;
    }
    
    .btn-recent {
      padding: 12px 20px;
      background: #6c757d;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s;
      white-space: nowrap;
    }
    
    .btn-recent:hover {
      background: #545b62;
    }

    .btn-deficiency-filter {
      background: linear-gradient(135deg, #ff9800, #f57c00);
      color: #fff;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-deficiency-filter:hover {
      background: linear-gradient(135deg, #f57c00, #e65100);
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(255, 152, 0, 0.3);
    }
    
    /* ========== æ¤œç´¢çµæœ ========== */
    .search-results {
      margin-top: 15px;
    }
    
    .results-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid #ddd;
    }
    
    .results-count {
      font-size: 14px;
      color: #666;
    }
    
    /* ========== åˆ—ãƒ˜ãƒƒãƒ€ãƒ¼ ========== */
    .results-column-header {
      display: grid;
      grid-template-columns: 35px 85px 1fr 120px 55px 55px 60px;
      gap: 8px;
      padding: 10px 15px;
      background: #667eea;
      color: white;
      font-size: 12px;
      font-weight: bold;
      border-radius: 6px 6px 0 0;
    }
    
    .results-column-header span {
      text-align: center;
    }
    
    .results-column-header span:nth-child(2) {
      text-align: left;
    }
    
    .results-column-header span:nth-child(3),
    .results-column-header span:nth-child(4) {
      text-align: left;
    }
    
    .results-list {
      max-height: 350px;
      overflow-y: auto;
      border: 1px solid #e0e0e0;
      border-top: none;
      border-radius: 0 0 6px 6px;
    }
    
    .result-item {
      display: flex;
      align-items: center;
      padding: 12px 15px;
      border-bottom: 1px solid #f0f0f0;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .result-item:last-child {
      border-bottom: none;
    }
    
    .result-item:hover {
      background-color: #f5f5f5;
    }
    
    .result-item.selected {
      background-color: #e8f0fe;
      border-left: 4px solid #667eea;
    }
    
    .result-radio {
      margin-right: 12px;
      width: 18px;
      height: 18px;
      cursor: pointer;
      flex-shrink: 0;
    }
    
    .result-info {
      flex: 1;
      display: grid;
      grid-template-columns: 85px 1fr 120px 55px 55px 60px;
      gap: 8px;
      align-items: center;
    }
    
    .result-member-id {
      font-weight: bold;
      color: #667eea;
      font-size: 14px;
    }
    
    .result-store-name {
      font-size: 14px;
      color: #333;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .result-wearer-name {
      font-size: 14px;
      color: #555;
    }
    
    .result-status {
      font-size: 12px;
      padding: 3px 8px;
      border-radius: 4px;
      text-align: center;
      min-width: 50px;
      white-space: nowrap;
    }

    .status-active {
      background: #d4edda;
      color: #155724;
    }

    .status-inactive {
      background: #f8d7da;
      color: #721c24;
    }

    .status-pending {
      background: #fff3cd;
      color: #856404;
    }

    .status-duplicate-deleted {
      background: #8b5cf6;
      color: white;
      white-space: nowrap;
      font-size: 11px;
      padding: 2px 6px;
    }
    
    /* ========== å°åˆ·å›æ•° ========== */
    .result-print-count {
      font-size: 13px;
      text-align: center;
      font-weight: bold;
    }
    
    /* ========== é¸æŠä¸­ã®ä¼šå“¡ ========== */
    .selected-member {
      background: #e8f0fe;
      border: 2px solid #667eea;
      border-radius: 8px;
      padding: 15px 20px;
      margin: 20px 0;
      display: none;
    }
    
    .selected-member.show {
      display: block;
    }
    
    .selected-member h3 {
      font-size: 14px;
      color: #667eea;
      margin-bottom: 10px;
    }
    
    .selected-info-row {
      display: flex;
      gap: 20px;
      align-items: center;
      flex-wrap: wrap;
      font-size: 15px;
      margin-bottom: 8px;
    }

    .selected-info-row:last-child {
      margin-bottom: 0;
    }

    .selected-info-row span {
      color: #333;
    }

    .selected-info-row strong {
      color: #667eea;
    }

    .selected-print-count {
      color: #28a745 !important;
      font-weight: bold;
    }
    
    /* ========== ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ ========== */
    .action-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr 1fr;
      gap: 15px;
      margin-top: 20px;
    }
    
    .btn {
      padding: 15px 20px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .btn-detail {
      background: #17a2b8;
      color: white;
    }
    
    .btn-detail:hover:not(:disabled) {
      background: #138496;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(23, 162, 184, 0.3);
    }
    
    .btn-card {
      background: #667eea;
      color: white;
    }
    
    .btn-card:hover:not(:disabled) {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }
    
    .btn-application {
      background: #28a745;
      color: white;
    }
    
    .btn-application:hover:not(:disabled) {
      background: #218838;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
    }
    
    .btn-both {
      background: #fd7e14;
      color: white;
    }
    
    .btn-both:hover:not(:disabled) {
      background: #e96b02;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(253, 126, 20, 0.3);
    }
    
    .btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    
    /* ========== ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ ========== */
    .message {
      padding: 15px;
      margin: 15px 0;
      border-radius: 6px;
      display: none;
    }
    
    .message.success {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }
    
    .message.error {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }
    
    .message.info {
      background: #d1ecf1;
      border: 1px solid #bee5eb;
      color: #0c5460;
    }
    
    /* ========== ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° ========== */
    .loading {
      display: none;
      text-align: center;
      padding: 30px;
    }
    
    .spinner {
      display: inline-block;
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* ========== çµæœãƒªãƒ³ã‚¯ ========== */
    .result-link {
      display: block;
      margin-top: 10px;
      padding: 12px;
      background: #e7f3ff;
      border-radius: 6px;
      text-align: center;
    }
    
    .result-link a {
      color: #0066cc;
      text-decoration: none;
      font-weight: bold;
      font-size: 15px;
    }
    
    .result-link a:hover {
      text-decoration: underline;
    }
    
    /* ========== ä¸€æ‹¬ç”Ÿæˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ ========== */
    .batch-section {
      margin-top: 30px;
      padding-top: 20px;
      border-top: 2px solid #e0e0e0;
    }
    
    .batch-section h3 {
      font-size: 14px;
      color: #666;
      margin-bottom: 15px;
    }
    
    .batch-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .btn-batch {
      padding: 10px 20px;
      background: #6c757d;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .btn-batch:hover {
      background: #545b62;
    }
    
    /* ========== å°åˆ·æ–¹æ³•ãƒ˜ãƒ«ãƒ— ========== */
    .help-box {
      background: #fff3cd;
      border: 1px solid #ffc107;
      padding: 15px;
      border-radius: 6px;
      margin-top: 20px;
      font-size: 13px;
      color: #856404;
    }
    
    .help-box strong {
      display: block;
      margin-bottom: 8px;
    }
    
    /* ========== ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– ========== */
    @media (max-width: 900px) {
      .action-buttons {
        grid-template-columns: 1fr 1fr;
      }
    }
    
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }
      
      .container {
        padding: 20px;
      }
      
      .search-box {
        flex-direction: column;
      }
      
      .results-column-header {
        display: none;
      }
      
      .result-info {
        grid-template-columns: 1fr;
        gap: 5px;
      }
      
      .result-item {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .result-radio {
        margin-bottom: 8px;
      }
      
      /* ãƒ¢ãƒã‚¤ãƒ«ç”¨ãƒ©ãƒ™ãƒ«è¡¨ç¤º */
      .result-info span::before {
        font-weight: bold;
        color: #667eea;
        margin-right: 5px;
      }
      
      .result-member-id::before { content: "ä¼šå“¡ID: "; }
      .result-store-name::before { content: "åº—å: "; }
      .result-wearer-name::before { content: "æ°å: "; }
      .result-print-count.card-count::before { content: "ã‚«ãƒ¼ãƒ‰: "; }
      .result-print-count.app-count::before { content: "ç”³è«‹æ›¸: "; }
      
      .action-buttons {
        grid-template-columns: 1fr;
      }
      
      .nav-links {
        flex-direction: column;
        align-items: center;
      }
    }


    /* ========== ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ãƒ¢ãƒ¼ãƒ€ãƒ« ========== */
.auth-overlay {
    display: flex;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    justify-content: center;
    align-items: center;
    z-index: 10000;
}

.auth-overlay.hidden {
    display: none;
}

.auth-modal {
    background: white;
    padding: 40px;
    border-radius: 16px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    text-align: center;
    max-width: 400px;
    width: 90%;
    animation: authModalIn 0.3s ease;
}

@keyframes authModalIn {
    from { opacity: 0; transform: scale(0.9) translateY(-20px); }
    to { opacity: 1; transform: scale(1) translateY(0); }
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    20%, 60% { transform: translateX(-10px); }
    40%, 80% { transform: translateX(10px); }
}

.auth-modal h2 {
    color: #4285f4;
    margin-bottom: 10px;
    font-size: 24px;
}

.auth-modal .auth-subtitle {
    color: #666;
    margin-bottom: 30px;
    font-size: 14px;
}

.auth-modal .auth-icon {
    font-size: 60px;
    margin-bottom: 20px;
}

.auth-modal input[type="password"] {
    width: 100%;
    padding: 15px;
    font-size: 18px;
    border: 2px solid #ddd;
    border-radius: 8px;
    margin-bottom: 20px;
    text-align: center;
    letter-spacing: 4px;
}

.auth-modal input[type="password"]:focus {
    outline: none;
    border-color: #4285f4;
    box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.2);
}

.auth-modal .auth-btn {
    width: 100%;
    padding: 15px;
    font-size: 16px;
    font-weight: bold;
    color: white;
    background: linear-gradient(135deg, #4285f4, #34a853);
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s;
}

.auth-modal .auth-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 20px rgba(66, 133, 244, 0.4);
}

.auth-modal .auth-btn:disabled {
    background: #ccc;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

.auth-modal .auth-error {
    color: #dc3545;
    font-size: 14px;
    margin-top: 15px;
    padding: 10px;
    background: #ffebee;
    border-radius: 6px;
    display: none;
}

.auth-modal .auth-error.show {
    display: block;
}

.auth-modal .auth-hint {
    color: #999;
    font-size: 12px;
    margin-top: 20px;
}
    /* ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚¹ã‚¿ã‚¤ãƒ« */
    .print-checkbox {
      width: 18px;
      height: 18px;
      cursor: default;
      accent-color: #28a745;
    }

    /* ========== â˜… è§£ç´„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒƒã‚¸ ========== */
    .cancel-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
      font-weight: 700;
      margin-left: 6px;
      vertical-align: middle;
      white-space: nowrap;
    }
    .cancel-badge.cancel-mail {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffc107;
    }
    .cancel-badge.cancel-pending {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
      animation: cancelBlink 1.5s ease-in-out infinite;
    }
    .cancel-badge.cancel-done {
      background: #e2e3e5;
      color: #383d41;
      border: 1px solid #d6d8db;
    }
    @keyframes cancelBlink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }
    /* é¸æŠä¸­ã®ä¼šå“¡ã‚»ã‚¯ã‚·ãƒ§ãƒ³ç”¨ã®å¤§ãã‚ãƒãƒƒã‚¸ */
    .cancel-badge-lg {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 13px;
      font-weight: 700;
      margin-left: 8px;
      vertical-align: middle;
    }
    .cancel-badge-lg.cancel-mail {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffc107;
    }
    .cancel-badge-lg.cancel-pending {
      background: #f8d7da;
      color: #721c24;
      border: 2px solid #dc3545;
      animation: cancelBlink 1.5s ease-in-out infinite;
    }
    .cancel-badge-lg.cancel-done {
      background: #e2e3e5;
      color: #383d41;
      border: 1px solid #d6d8db;
    }
    /* è§£ç´„æ¸ˆã¿ã«ã™ã‚‹ãƒœã‚¿ãƒ³ */
    .btn-complete-cancel {
      display: inline-block;
      padding: 4px 14px;
      margin-left: 8px;
      background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      vertical-align: middle;
      transition: all 0.3s;
    }
    .btn-complete-cancel:hover {
      background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(220, 53, 69, 0.4);
    }
    .btn-complete-cancel:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
  .deficiency-badge {
    display: inline-block;
    padding: 2px 10px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 700;
    margin-left: 8px;
    vertical-align: middle;
  }
  .deficiency-badge.def-notified {
    background: #fff3cd;
    color: #856404;
    border: 1px solid #ffc107;
    animation: blink 1.5s ease-in-out infinite;
  }
  .deficiency-badge.def-resubmitted {
    background: #d1ecf1;
    color: #0c5460;
    border: 1px solid #17a2b8;
  }
  .deficiency-badge.def-issued {
    background: #d4edda;
    color: #155724;
    border: 1px solid #28a745;
  }

    .resubmit-alert {
      margin: 0 auto 16px;
      max-width: 1050px;
      animation: slideDown 0.4s ease-out;
    }
    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .resubmit-alert-inner {
      background: linear-gradient(135deg, #fff3e0, #ffe0b2);
      border: 2px solid #ff9800;
      border-radius: 10px;
      padding: 14px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      box-shadow: 0 2px 8px rgba(255, 152, 0, 0.2);
    }
    .resubmit-alert-icon {
      font-size: 24px;
      flex-shrink: 0;
    }
    .resubmit-alert-text {
      flex: 1;
      font-size: 14px;
      font-weight: 600;
      color: #e65100;
    }
    .resubmit-alert-btn {
      background: #ff9800;
      color: #fff;
      border: none;
      padding: 8px 18px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      white-space: nowrap;
      transition: background 0.2s;
    }
    .resubmit-alert-btn:hover {
      background: #f57c00;
    }
    .resubmit-alert-close {
      background: none;
      border: none;
      font-size: 18px;
      color: #bf360c;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
      flex-shrink: 0;
    }
    .resubmit-alert-close:hover {
      background: rgba(191, 54, 12, 0.1);
    }

  .btn-deficiency {
    background: #ff9800;
    color: #fff;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 700;
    cursor: pointer;
    transition: background 0.2s;
  }
  .btn-deficiency:hover {
    background: #f57c00;
  }

  .deficiency-modal-overlay {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.5);
  display: flex;
  justify-content: center;
  align-items: center;      /* â† ã“ã‚ŒãŒé‡è¦ï¼šä¸­å¤®é…ç½® */
  z-index: 10000;
  }

  .deficiency-modal {
    background: #fff;
    border-radius: 12px;
    padding: 24px;
    width: 90%;
    max-width: 520px;
    max-height: 85vh;        /* â† è¿½åŠ ï¼šç”»é¢ã®85%ã¾ã§ */
    overflow-y: auto;        /* â† è¿½åŠ ï¼šã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ã« */
    box-shadow: 0 8px 32px rgba(0,0,0,0.2);
  }

  .deficiency-modal h3 {
    font-size: 18px;
    margin-bottom: 16px;
    color: #333;
  }

  .deficiency-modal .form-group {
    margin-bottom: 16px;
  }

  .deficiency-modal label {
    display: block;
    font-size: 13px;
    font-weight: 600;
    color: #555;
    margin-bottom: 6px;
  }

  .deficiency-modal select,
  .deficiency-modal textarea {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 14px;
    font-family: inherit;
  }

  .deficiency-modal textarea {
    height: 80px;
    resize: vertical;
  }

  .deficiency-modal .modal-buttons {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    margin-top: 20px;
  }

  .deficiency-modal .btn-cancel {
    padding: 10px 20px;
    border: 1px solid #ddd;
    border-radius: 8px;
    background: #fff;
    color: #666;
    font-size: 14px;
    cursor: pointer;
  }

  .deficiency-modal .btn-send {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    background: #ff9800;
    color: #fff;
    font-size: 14px;
    font-weight: 700;
    cursor: pointer;
  }

  .deficiency-modal .btn-send:disabled {
    background: #ccc;
    cursor: not-allowed;
  }

  .deficiency-modal .member-summary {
    background: #f5f5f5;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 16px;
    font-size: 13px;
  }

  .deficiency-modal .member-summary strong {
    color: #333;
  }

// ================================================================
// CSSï¼šãƒšãƒ¼ã‚¸ãƒ³ã‚°UIã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¿½åŠ 
// ================================================================
      .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      padding: 14px 0;
      margin-top: 8px;
      border-top: 1px solid #e0e0e0;
    }
    .page-btn {
      padding: 8px 16px;
      border: 1px solid #1976d2;
      background: #fff;
      color: #1976d2;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: bold;
      transition: all 0.2s;
    }
    .page-btn:hover:not(:disabled) {
      background: #1976d2;
      color: #fff;
    }
    .page-btn:disabled {
      border-color: #ccc;
      color: #ccc;
      cursor: not-allowed;
      background: #f5f5f5;
    }
    .page-info {
      font-size: 14px;
      color: #555;
      font-weight: bold;
      min-width: 100px;
      text-align: center;
    }

    .deficiency-step { display: none; }
.deficiency-step.active { display: block; }

.email-preview-box {
  background: #f8f9fa;
  border: 1px solid #dee2e6;
  border-radius: 8px;
  padding: 16px;
  margin: 12px 0;
}
.email-preview-box .preview-label {
  font-size: 12px;
  color: #6c757d;
  font-weight: 600;
  margin-bottom: 4px;
}
.email-preview-box .preview-subject {
  font-size: 14px;
  font-weight: 700;
  color: #333;
  padding: 8px;
  background: #fff;
  border: 1px solid #ced4da;
  border-radius: 4px;
  margin-bottom: 12px;
  width: 100%;
  box-sizing: border-box;
}
.email-preview-box .preview-to {
  font-size: 13px;
  color: #495057;
  margin-bottom: 8px;
  padding: 6px 8px;
  background: #e9ecef;
  border-radius: 4px;
}
.email-preview-box textarea.preview-body {
  width: 100%;
  min-height: 280px;
  font-size: 13px;
  line-height: 1.6;
  border: 1px solid #ced4da;
  border-radius: 4px;
  padding: 10px;
  resize: vertical;
  font-family: inherit;
  box-sizing: border-box;
}
.confirm-box {
  background: #fff3cd;
  border: 1px solid #ffc107;
  border-radius: 8px;
  padding: 16px;
  margin: 12px 0;
  text-align: center;
}
.confirm-box .confirm-icon { font-size: 36px; margin-bottom: 8px; }
.confirm-box .confirm-text { font-size: 14px; color: #664d03; font-weight: 600; }
.confirm-box .confirm-to { font-size: 16px; font-weight: 700; color: #333; margin-top: 8px; }
.step-indicator { display: flex; justify-content: center; gap: 8px; margin-bottom: 16px; }
.step-dot { width: 10px; height: 10px; border-radius: 50%; background: #dee2e6; }
.step-dot.active { background: #0d6efd; }
.step-dot.done { background: #198754; }
.btn-back {
  background: #6c757d; color: #fff; border: none;
  padding: 10px 20px; border-radius: 8px; font-size: 14px; font-weight: 700; cursor: pointer;
}
.btn-preview {
  background: #0d6efd; color: #fff; border: none;
  padding: 10px 20px; border-radius: 8px; font-size: 14px; font-weight: 700; cursor: pointer;
}
.btn-confirm-send {
  background: #dc3545; color: #fff; border: none;
  padding: 10px 20px; border-radius: 8px; font-size: 14px; font-weight: 700; cursor: pointer;
}
  </style>
</head>
<body>

<!-- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
<div id="authOverlay" class="auth-overlay">
    <div class="auth-modal">
        <div class="auth-icon">ğŸ”</div>
        <h2>ç®¡ç†è€…èªè¨¼</h2>
        <p class="auth-subtitle">ç®¡ç†ç”»é¢ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã«ã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå¿…è¦ã§ã™</p>
        
        <form id="authForm" onsubmit="return handleAuthSubmit(event)">
            <input type="password" id="authPassword" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›" autocomplete="current-password" required>
            <button type="submit" class="auth-btn" id="authSubmitBtn">ğŸ”“ ãƒ­ã‚°ã‚¤ãƒ³</button>
        </form>
        
        <div id="authError" class="auth-error"></div>
        
        <p class="auth-hint">â€» ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¿˜ã‚ŒãŸå ´åˆã¯ç®¡ç†è€…ã«é€£çµ¡ã—ã¦ãã ã•ã„</p>
    </div>
</div>
  
  <div class="container">
    <h1>ğŸ« è²·å‡ºäººç« ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
    <div class="subtitle">ä¼šå“¡æ¤œç´¢ãƒ»ã‚«ãƒ¼ãƒ‰ç”Ÿæˆãƒ»ç”³è«‹æ›¸å°åˆ·</div>
    
    <!-- â˜…ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒªãƒ³ã‚¯è¿½åŠ  -->
    <div class="nav-links">
      <a href="EmailSender.html" class="nav-link email">ğŸ“§ ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚·ã‚¹ãƒ†ãƒ </a>
      <a href="index.html" class="nav-link form" target="_blank">ğŸ“ ç”³è«‹ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‹ã</a>
    </div>
    
    <!-- â˜… å†æå‡ºã‚¢ãƒ©ãƒ¼ãƒˆ -->
    <div id="resubmitAlert" class="resubmit-alert" style="display: none;">
      <div class="resubmit-alert-inner">
        <span class="resubmit-alert-icon">ğŸ””</span>
        <span class="resubmit-alert-text" id="resubmitAlertText"></span>
        <button class="resubmit-alert-btn" onclick="loadDeficiencyMembers(1)">ä¸å‚™ä¸€è¦§ã‚’è¡¨ç¤º</button>
        <button class="resubmit-alert-close" onclick="dismissResubmitAlert()" title="é–‰ã˜ã‚‹">âœ•</button>
      </div>
    </div>

    <!-- æ¤œç´¢ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="search-section">
      <h2>ğŸ” ä¼šå“¡æ¤œç´¢</h2>
      <div class="search-box">
        <input type="text" 
               class="search-input" 
               id="searchKeyword" 
               placeholder="ä¼šå“¡ç•ªå·ã€åº—åã€æ°åã§æ¤œç´¢ï¼ˆä¾‹ï¼šK10032ã€éŠ€åº§ã€å±±ç”°ï¼‰"
               onkeypress="handleSearchKeypress(event)">
        <button class="btn-search" onclick="searchMembers()">ğŸ” æ¤œç´¢</button>
        <button class="btn-recent" onclick="loadPagedMembers(1)">ğŸ“‹ å…¨ä»¶è¡¨ç¤º</button>
        <button class="btn-deficiency-filter" onclick="loadDeficiencyMembers(1)">âš ï¸ ä¸å‚™ã®ã¿</button>
      </div>
      
      <!-- æ¤œç´¢çµæœ -->
      <div class="search-results" id="searchResults" style="display: none;">
        <div class="results-header">
          <span class="results-count" id="resultsCount">0ä»¶</span>
        </div>
        <!-- åˆ—ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="results-column-header">
          <span></span>
          <span>ä¼šå“¡ID</span>
          <span>åº—å</span>
          <span>æ°å</span>
          <span>ã‚«ãƒ¼ãƒ‰æ¸ˆ</span>
          <span>ç”³è«‹æ›¸æ¸ˆ</span>
          <span>çŠ¶æ…‹</span>
        </div>
        <div class="results-list" id="resultsList">
          <!-- æ¤œç´¢çµæœãŒã“ã“ã«å…¥ã‚‹ -->
        </div>
          <!-- ãƒšãƒ¼ã‚¸ãƒ³ã‚° -->
          <div class="pagination" id="pagination" style="display: none;">
            <button class="page-btn" id="btnFirstPage" onclick="goToPage('first')">â‰ª æœ€åˆ</button>
            <button class="page-btn" id="btnPrevPage" onclick="goToPage('prev')">â—€ å‰ã¸</button>
            <span class="page-info" id="pageInfo">1 / 1</span>
            <button class="page-btn" id="btnNextPage" onclick="goToPage('next')">æ¬¡ã¸ â–¶</button>
            <button class="page-btn" id="btnLastPage" onclick="goToPage('last')">æœ€å¾Œ â‰«</button>
          </div>

      </div>
    </div>
    
    <!-- é¸æŠä¸­ã®ä¼šå“¡ -->
    <div class="selected-member" id="selectedMember">
      <h3>ğŸ“Œ é¸æŠä¸­ã®ä¼šå“¡</h3>
      <div class="selected-info-row">
        <span><strong>ä¼šå“¡ç•ªå·:</strong> <span id="selectedMemberId">-</span></span>
        <span><strong>åº—å:</strong> <span id="selectedStoreName">-</span></span>
        <span><strong>ç€ç”¨è€…:</strong> <span id="selectedWearerName">-</span></span>
        <span id="selectedCancelStatusArea"></span>
      </div>
      <div class="selected-info-row">
        <span><strong>ã‚«ãƒ¼ãƒ‰:</strong> <input type="checkbox" id="selectedCardCheck" class="print-checkbox" onclick="toggleSelectedPrintStatus('card', this)"></span>
        <span><strong>ç”³è«‹æ›¸:</strong> <input type="checkbox" id="selectedAppCheck" class="print-checkbox" onclick="toggleSelectedPrintStatus('app', this)"></span>
        <span><strong>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</strong> <span id="selectedStatus">-</span></span>
        <span><strong>ä¸å‚™:</strong>
          <select id="selectedDeficiencyStatus" onchange="updateDeficiencyStatus(this.value)" style="padding:4px 8px; border-radius:6px; border:1px solid #ccc; font-size:13px;">
            <option value="">â€•</option>
            <option value="ä¸å‚™é€£çµ¡æ¸ˆã¿">ä¸å‚™é€£çµ¡æ¸ˆã¿</option>
            <option value="å†æå‡ºæ¸ˆã¿">å†æå‡ºæ¸ˆã¿</option>
            <option value="ç™ºè¡Œå®Œäº†">ç™ºè¡Œå®Œäº†</option>
          </select>
        </span>
      </div>
    </div>
    
    <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
    <div class="action-buttons">
      <button class="btn btn-detail" id="btnDetail" onclick="openMemberDetail()" disabled>
        ğŸ‘¤ ä¼šå“¡è©³ç´°
      </button>
      <button class="btn btn-card" id="btnCard" onclick="generateCard()" disabled>
        ğŸ« ã‚«ãƒ¼ãƒ‰ç”Ÿæˆ
      </button>
      <button class="btn btn-application" id="btnApplication" onclick="generateApplication()" disabled>
        ğŸ“‹ ç”³è«‹æ›¸ç”Ÿæˆ
      </button>
      <button class="btn btn-both" id="btnBoth" onclick="generateBoth()" disabled>
        ğŸ“¦ ä¸¡æ–¹ç”Ÿæˆ
      </button>
    </div>

    <!-- â˜… ä¸å‚™é€£çµ¡ãƒ»äºŒé‡å‰Šé™¤ãƒ»ä¼šè²»ãƒšã‚¤ãƒœã‚¿ãƒ³ -->
    <div style="margin-top: 10px; text-align: right; display: flex; gap: 10px; justify-content: flex-end; flex-wrap: wrap;">
      <button class="btn-deficiency" id="btnDeficiency" onclick="openDeficiencyModal()" disabled>
        âš ï¸ ä¸å‚™é€£çµ¡
      </button>
      <button id="btnDuplicate" onclick="deleteDuplicateMember()" disabled
        style="padding: 8px 16px; background: #8b5cf6; color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: bold; cursor: pointer;">
        ğŸ—‘ äºŒé‡ç™»éŒ²å‰Šé™¤
      </button>
      <button id="btnCheckKaihipay" onclick="checkKaihipayStatus()" disabled
        style="padding: 8px 16px; background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: bold; cursor: pointer;">
        ğŸ” ä¼šè²»ãƒšã‚¤çŠ¶æ…‹ç¢ºèª
      </button>
      <button id="btnRetryKaihipay" onclick="retryKaihipayRegistration()" disabled
        style="padding: 8px 16px; background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%); color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: bold; cursor: pointer; box-shadow: 0 2px 8px rgba(255,107,53,0.3);">
        ğŸ’³ ä¼šè²»ãƒšã‚¤å†ç™»éŒ²
      </button>
    </div>
    
    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
    <div class="loading" id="loading">
      <div class="spinner"></div>
      <div style="margin-top: 10px;">å‡¦ç†ä¸­...</div>
    </div>
    
    <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
    <div class="message" id="message"></div>
    
    <!-- å°åˆ·æ–¹æ³•ãƒ˜ãƒ«ãƒ— -->
    <div class="help-box">
      <strong>ğŸ’¾ PDFå°åˆ·æ–¹æ³•ï¼š</strong>
      1. ç”Ÿæˆã•ã‚ŒãŸãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯<br>
      2. ã€Œãƒ•ã‚¡ã‚¤ãƒ«ã€â†’ã€Œãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€â†’ã€ŒPDFã€ã‚’é¸æŠ<br>
      3. ã‚«ãƒ¼ãƒ‰: B5ç¸¦ã§å°åˆ·ï¼ˆä¸Šéƒ¨55mmã«ã‚«ãƒ¼ãƒ‰ï¼‰ / ç”³è«‹æ›¸: A4ç¸¦ã§å°åˆ·
    </div>
    
    <!-- ä¸€æ‹¬ç”Ÿæˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="batch-section">
      <h3>âš™ï¸ ä¸€æ‹¬å‡¦ç†ãƒ»ãƒ†ã‚¹ãƒˆ</h3>
      <div class="batch-buttons">
        <button class="btn-batch" onclick="generateTestCard()">ğŸ§ª ãƒ†ã‚¹ãƒˆã‚«ãƒ¼ãƒ‰ç”Ÿæˆ</button>
        <button class="btn-batch" onclick="generateAllCards()">ğŸ“Š å…¨ã‚«ãƒ¼ãƒ‰ä¸€æ‹¬ç”Ÿæˆ</button>
        <button class="btn-batch" onclick="generateAllApplications()">ğŸ“Š å…¨ç”³è«‹æ›¸ä¸€æ‹¬ç”Ÿæˆ</button>
      </div>
    </div>
  </div>
  
  <script>

// ========== ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ã‚·ã‚¹ãƒ†ãƒ  ========== //

const AUTH_STORAGE_KEY = 'ota_admin_auth';
const AUTH_EXPIRY_HOURS = 24;

function checkAuthentication() {
    const authData = localStorage.getItem(AUTH_STORAGE_KEY);
    
    if (!authData) {
        showAuthModal();
        return false;
    }
    
    try {
        const { token, expiresAt } = JSON.parse(authData);
        
        if (Date.now() > expiresAt) {
            localStorage.removeItem(AUTH_STORAGE_KEY);
            showAuthModal();
            return false;
        }
        
        hideAuthModal();
        return true;
        
    } catch (e) {
        localStorage.removeItem(AUTH_STORAGE_KEY);
        showAuthModal();
        return false;
    }
}

function showAuthModal() {
    document.getElementById('authOverlay').classList.remove('hidden');
    document.getElementById('authPassword').focus();
    document.body.style.overflow = 'hidden';
}

function hideAuthModal() {
    document.getElementById('authOverlay').classList.add('hidden');
    document.body.style.overflow = '';
}

async function handleAuthSubmit(event) {
    event.preventDefault();
    
    const password = document.getElementById('authPassword').value;
    const submitBtn = document.getElementById('authSubmitBtn');
    const errorDiv = document.getElementById('authError');
    
    if (!password) {
        showAuthError('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return false;
    }
    
    submitBtn.disabled = true;
    submitBtn.textContent = 'ğŸ”„ èªè¨¼ä¸­...';
    errorDiv.classList.remove('show');
    
    try {
        // IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—
        let clientIP = '';
        try {
            const ipResponse = await fetch('https://api.ipify.org?format=json');
            const ipData = await ipResponse.json();
            clientIP = ipData.ip;
        } catch (e) { }
        
        const response = await fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'text/plain' },
            body: JSON.stringify({
                action: 'verifyAdminPassword',
                password: password,
                clientIP: clientIP
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            const authData = {
                token: result.token,
                expiresAt: result.expiresAt
            };
            localStorage.setItem(AUTH_STORAGE_KEY, JSON.stringify(authData));
            
            hideAuthModal();
            
            if (typeof initializePage === 'function') {
                initializePage();
            }
            
        } else {
            showAuthError(result.error || 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
        }
        
    } catch (error) {
        console.error('èªè¨¼ã‚¨ãƒ©ãƒ¼:', error);
        showAuthError('èªè¨¼ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'ğŸ”“ ãƒ­ã‚°ã‚¤ãƒ³';
    }
    
    return false;
}

function showAuthError(message) {
    const errorDiv = document.getElementById('authError');
    errorDiv.textContent = message;
    errorDiv.classList.add('show');
    
    const passwordInput = document.getElementById('authPassword');
    passwordInput.style.animation = 'none';
    passwordInput.offsetHeight;
    passwordInput.style.animation = 'shake 0.5s';
    passwordInput.select();
}

function logout() {
    localStorage.removeItem(AUTH_STORAGE_KEY);
    showAuthModal();
}

    // ========== IPã‚¢ãƒ‰ãƒ¬ã‚¹å–å¾— ========== //
    let cachedClientIP = null;
    
    async function getClientIP() {
      if (cachedClientIP) return cachedClientIP;
      try {
        const response = await fetch('https://api.ipify.org?format=json', { timeout: 3000 });
        const data = await response.json();
        cachedClientIP = data.ip;
        return data.ip;
      } catch (e) {
        console.log('IPå–å¾—ã‚¹ã‚­ãƒƒãƒ—');
        return '';
      }
    }
    
    // èµ·å‹•æ™‚ã«IPã‚’å–å¾—ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰
    getClientIP();
    
    // â˜… GAS API URLï¼ˆãƒ‡ãƒ—ãƒ­ã‚¤URLã‚’è¨­å®šï¼‰
    const API_URL = 'https://script.google.com/macros/s/AKfycbwbbyZoRzhWu8Ft5xVvyI1LJc7_RLZaeLwVGapXnlYIIJBUSlgJXQTzofwuLl5nux43kg/exec';
    
    // â˜… MemberDetail.html ã®URLï¼ˆGitHub Pagesï¼‰
    const MEMBER_DETAIL_URL = 'https://otajigyokyo.github.io/appliyform/MemberDetail.html';
    
    // é¸æŠä¸­ã®ä¼šå“¡ãƒ‡ãƒ¼ã‚¿
    let selectedMemberData = null;
    
    // ========== APIå‘¼ã³å‡ºã—å…±é€šé–¢æ•° ========== //
    async function callApi(action, data = {}) {
      try {
        const clientIP = await getClientIP();
        const response = await fetch(API_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'text/plain',
          },
          body: JSON.stringify({ action, clientIP, ...data })
        });
        return await response.json();
      } catch (error) {
        console.error('APIå‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼:', error);
        throw error;
      }
    }
    
    // ========== â˜… è§£ç´„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ ãƒãƒƒã‚¸ç”Ÿæˆ ========== //
    
    function getCancelBadge(cancelStatus) {
      if (!cancelStatus) return '';
      if (cancelStatus === 'è§£ç´„ãƒ¡ãƒ¼ãƒ«é€ä¿¡') {
        return '<span class="cancel-badge cancel-mail">è§£ç´„ãƒ¡ãƒ¼ãƒ«é€ä¿¡</span>';
      }
      if (cancelStatus === 'è§£ç´„ç”³è«‹ä¸­') {
        return '<span class="cancel-badge cancel-pending">è§£ç´„ç”³è«‹ä¸­</span>';
      }
      if (cancelStatus === 'è§£ç´„æ¸ˆã¿') {
        return '<span class="cancel-badge cancel-done">è§£ç´„æ¸ˆã¿</span>';
      }
      return '';
    }
    
    function getCancelBadgeLg(cancelStatus) {
      if (!cancelStatus) return '';
      var cls = '';
      if (cancelStatus === 'è§£ç´„ãƒ¡ãƒ¼ãƒ«é€ä¿¡') cls = 'cancel-mail';
      else if (cancelStatus === 'è§£ç´„ç”³è«‹ä¸­') cls = 'cancel-pending';
      else if (cancelStatus === 'è§£ç´„æ¸ˆã¿') cls = 'cancel-done';
      else return '';
      var html = '<span class="cancel-badge-lg ' + cls + '">' + escapeHtml(cancelStatus) + '</span>';
      // â˜… è§£ç´„ç”³è«‹ä¸­ã®å ´åˆã«ã€Œè§£ç´„æ¸ˆã¿ã«ã™ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
      if (cancelStatus === 'è§£ç´„ç”³è«‹ä¸­') {
        html += '<button class="btn-complete-cancel" onclick="completeCancelAction()">âœ” è§£ç´„æ¸ˆã¿ã«ã™ã‚‹</button>';
      }
      return html;
    }

    function getDeficiencyBadge(defStatus) {
      if (!defStatus) return '';
      if (defStatus === 'ä¸å‚™é€£çµ¡æ¸ˆã¿') {
        return '<span class="deficiency-badge def-notified">ä¸å‚™é€£çµ¡æ¸ˆã¿</span>';
      }
      if (defStatus === 'å†æå‡ºæ¸ˆã¿') {
        return '<span class="deficiency-badge def-resubmitted">å†æå‡ºæ¸ˆã¿</span>';
      }
      if (defStatus === 'ç™ºè¡Œå®Œäº†') {
        return '<span class="deficiency-badge def-issued">ç™ºè¡Œå®Œäº†</span>';
      }
      return '';
    }
    
    // ========== æ¤œç´¢æ©Ÿèƒ½ ========== //
    
    function handleSearchKeypress(event) {
      if (event.key === 'Enter') {
        searchMembers();
      }
    }
    
    // ========== æ¤œç´¢ï¼ˆãƒšãƒ¼ã‚¸ãƒ³ã‚°å¯¾å¿œï¼‰ ========== //
    async function searchMembers() {
      var keyword = document.getElementById('searchKeyword').value.trim();
      
      if (!keyword) {
        showMessage('æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
        return;
      }
      
      currentKeyword = keyword;
      currentMode = 'search';
      await searchMembersPage(1);
    }

    async function searchMembersPage(page) {
      showLoading(true);
      hideMessage();
      document.getElementById('resultsList').innerHTML = '';
      
      try {
        var result = await callApi('searchMembersPaged', { 
          keyword: currentKeyword, 
          page: page, 
          perPage: perPage 
        });
        showLoading(false);
        
        if (result.success) {
          currentPage = result.currentPage;
          totalPages = result.totalPages;
          displaySearchResults(result.results, result.message);
          updatePagination();
        } else {
          showMessage('âŒ ' + result.error, 'error');
        }
      } catch (error) {
        showLoading(false);
        showMessage('âŒ ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
      }
    }

    // ========== ä¸å‚™ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹çµã‚Šè¾¼ã¿ï¼ˆãƒšãƒ¼ã‚¸ãƒ³ã‚°å¯¾å¿œï¼‰ ========== //

    // ========== å†æå‡ºã‚¢ãƒ©ãƒ¼ãƒˆãƒã‚§ãƒƒã‚¯ ========== //
    async function checkResubmitAlert() {
      try {
        const result = await callApi('getDeficiencyMembers', { page: 1, perPage: 100 });
        if (!result.success) return;

        // ã€Œå†æå‡ºæ¸ˆã¿ã€ã®ä¼šå“¡ã‚’æ•°ãˆã‚‹
        const resubmitted = (result.results || []).filter(
          m => m.deficiencyStatus === 'å†æå‡ºæ¸ˆã¿'
        );

        const alertEl = document.getElementById('resubmitAlert');
        const textEl = document.getElementById('resubmitAlertText');

        if (resubmitted.length > 0) {
          const names = resubmitted.slice(0, 3).map(
            m => m.memberId + ' ' + m.storeName
          ).join('ã€');
          const suffix = resubmitted.length > 3
            ? ' ä»–' + (resubmitted.length - 3) + 'ä»¶'
            : '';

          textEl.textContent = 'ğŸ“‹ æ›¸é¡ã®å†æå‡ºãŒã‚ã‚Šã¾ã™ï¼ˆ'
            + resubmitted.length + 'ä»¶ï¼‰ï¼š' + names + suffix;
          alertEl.style.display = 'block';
        } else {
          alertEl.style.display = 'none';
        }
      } catch (error) {
        console.log('å†æå‡ºã‚¢ãƒ©ãƒ¼ãƒˆãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    function dismissResubmitAlert() {
      document.getElementById('resubmitAlert').style.display = 'none';
    }

async function loadDeficiencyMembers(page) {
      // â˜… ãƒœã‚¿ãƒ³ã‚’å³åº§ã«ç„¡åŠ¹åŒ–ï¼‹ãƒ†ã‚­ã‚¹ãƒˆå¤‰æ›´
      var btn = document.querySelector('.btn-deficiency-filter');
      if (btn) {
        btn.disabled = true;
        btn.textContent = 'â³ èª­è¾¼ä¸­...';
      }
      
      showLoading(true);
      hideMessage();
      currentMode = 'deficiency';

      try {
        var result = await callApi('getDeficiencyMembers', { page: page, perPage: perPage });
        showLoading(false);

        if (result.success) {
          currentPage = result.currentPage;
          totalPages = result.totalPages;
          displaySearchResults(result.results, result.message);
          updatePagination();
        } else {
          showMessage('âŒ ã‚¨ãƒ©ãƒ¼: ' + result.error, 'error');
        }
      } catch (error) {
        showLoading(false);
        showMessage('âŒ ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
      } finally {
        // â˜… ãƒœã‚¿ãƒ³ã‚’å¾©å…ƒ
        if (btn) {
          btn.disabled = false;
          btn.textContent = 'âš ï¸ ä¸å‚™ã®ã¿';
        }
      }
    }
    
    // ========== ãƒšãƒ¼ã‚¸ãƒ³ã‚°æ“ä½œ ========== //

    function updatePagination() {
      var paginationEl = document.getElementById('pagination');
      
      if (totalPages <= 1) {
        paginationEl.style.display = 'none';
        return;
      }
      
      paginationEl.style.display = 'flex';
      document.getElementById('pageInfo').textContent = currentPage + ' / ' + totalPages + ' ãƒšãƒ¼ã‚¸';
      document.getElementById('btnFirstPage').disabled = (currentPage <= 1);
      document.getElementById('btnPrevPage').disabled = (currentPage <= 1);
      document.getElementById('btnNextPage').disabled = (currentPage >= totalPages);
      document.getElementById('btnLastPage').disabled = (currentPage >= totalPages);
    }

    function goToPage(direction) {
      var targetPage = currentPage;
      
      if (direction === 'first') targetPage = 1;
      else if (direction === 'prev') targetPage = currentPage - 1;
      else if (direction === 'next') targetPage = currentPage + 1;
      else if (direction === 'last') targetPage = totalPages;
      
      if (targetPage < 1 || targetPage > totalPages || targetPage === currentPage) return;
      
      // å¤‰æ›´å¾Œ
      if (currentMode === 'search') {
        searchMembersPage(targetPage);
      } else if (currentMode === 'deficiency') {
        loadDeficiencyMembers(targetPage);
      } else {
        loadPagedMembers(targetPage);
      }
    }

    // ========== æ—§é–¢æ•°ã®äº’æ›ãƒ©ãƒƒãƒ‘ãƒ¼ ========== //

    function loadRecentMembers() {
      loadPagedMembers(1);
    }
    
    // ========== ãƒšãƒ¼ã‚¸ãƒ³ã‚°çŠ¶æ…‹ç®¡ç† ========== //

    var currentPage = 1;
    var totalPages = 1;
    var perPage = 50;
    var currentMode = 'list';  // 'list' or 'search' or 'deficiency'
    var currentKeyword = '';        // æ¤œç´¢ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ä¿æŒ

    // ========== å…¨ä»¶è¡¨ç¤ºï¼ˆãƒšãƒ¼ã‚¸ãƒ³ã‚°ï¼‰ ========== //

    async function loadPagedMembers(page) {
      showLoading(true);
      hideMessage();
      document.getElementById('resultsList').innerHTML = '';
      currentMode = 'list';
      
      try {
        var result = await callApi('getPagedMembers', { page: page, perPage: perPage });
        showLoading(false);
        
        if (result.success) {
          currentPage = result.currentPage;
          totalPages = result.totalPages;
          displaySearchResults(result.results, result.message);
          updatePagination();
        } else {
          showMessage('âŒ ã‚¨ãƒ©ãƒ¼: ' + result.error, 'error');
        }
      } catch (error) {
        showLoading(false);
        showMessage('âŒ ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
      }
    }
    
    function displaySearchResults(results, message) {
      const container = document.getElementById('searchResults');
      const listEl = document.getElementById('resultsList');
      const countEl = document.getElementById('resultsCount');
      
      container.style.display = 'block';
      countEl.textContent = message || `${results.length}ä»¶`;
      
      if (!results || results.length === 0) {
        listEl.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">è©²å½“ã™ã‚‹ä¼šå“¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div>';
        return;
      }
      
      listEl.innerHTML = results.map((member, index) => {
        const cardCount = member.cardPrintCount || 0;
        const appCount = member.appPrintCount || 0;
        // â˜… è§£ç´„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å–å¾—
        const cancelStatus = member.cancelStatus || '';
        const cancelBadgeHtml = getCancelBadge(cancelStatus);
        // â˜… ä¸å‚™ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å–å¾— â† ã“ã®2è¡Œã‚’è¿½åŠ 
        const deficiencyStatus = member.deficiencyStatus || '';
        const deficiencyBadgeHtml = getDeficiencyBadge(deficiencyStatus);
        // â˜… DUPLICATE_DELETEDåˆ¤å®š
        const isDupDeleted = (member.status || '').toUpperCase() === 'DUPLICATE_DELETED';
        const rowStyle = isDupDeleted ? 'opacity:0.5; background:#f0f0f0;' : '';
        const cbDisabled = isDupDeleted ? 'disabled' : '';

        return `
        <div class="result-item" onclick="selectMember(${index}, this)" data-index="${index}" style="${rowStyle}">
          <input type="radio" name="memberSelect" class="result-radio" onclick="event.stopPropagation(); selectMember(${index}, this.closest('.result-item'))">
          <div class="result-info">
            <span class="result-member-id">${escapeHtml(member.memberId)}</span>
            <span class="result-store-name">${escapeHtml(member.storeName)}${cancelBadgeHtml}${deficiencyBadgeHtml}</span>
            <span class="result-wearer-name">${escapeHtml(member.wearerName || member.representativeName)}</span>
            <span class="result-print-count card-count"><input type="checkbox" class="print-checkbox" ${cardCount > 0 ? 'checked' : ''} ${cbDisabled} onclick="event.stopPropagation(); togglePrintStatus(${index}, 'card', this)"></span>
            <span class="result-print-count app-count"><input type="checkbox" class="print-checkbox" ${appCount > 0 ? 'checked' : ''} ${cbDisabled} onclick="event.stopPropagation(); togglePrintStatus(${index}, 'app', this)"></span>
            <span class="result-status ${getStatusClass(member.status)}">${getStatusText(member.status)}</span>
          </div>
        </div>
      `;
      }).join('');
      
      // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
      window.searchResultsData = results;
      
      // é¸æŠçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
      selectedMemberData = null;
      document.getElementById('selectedMember').classList.remove('show');
      setButtonsEnabled(false);
    }
    
    function selectMember(index, element) {
      // é¸æŠã‚¹ã‚¿ã‚¤ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆ
      document.querySelectorAll('.result-item').forEach(item => item.classList.remove('selected'));
      element.classList.add('selected');
      element.querySelector('.result-radio').checked = true;
      
      // ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
      const member = window.searchResultsData[index];
      selectedMemberData = member;
      
      // é¸æŠä¸­ã®ä¼šå“¡è¡¨ç¤ºã‚’æ›´æ–°
      document.getElementById('selectedMemberId').textContent = member.memberId || '-';
      document.getElementById('selectedStoreName').textContent = member.storeName || '-';
      document.getElementById('selectedWearerName').textContent = member.wearerName || member.representativeName || '-';
      document.getElementById('selectedCardCheck').checked = (member.cardPrintCount || 0) > 0;
      document.getElementById('selectedAppCheck').checked = (member.appPrintCount || 0) > 0;
      document.getElementById('selectedStatus').textContent = getStatusText(member.status);
      
      // â˜… è§£ç´„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
      const cancelStatus = member.cancelStatus || '';
      document.getElementById('selectedCancelStatusArea').innerHTML = getCancelBadgeLg(cancelStatus);

      // â˜… ä¸å‚™ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã«åæ˜ 
      document.getElementById('selectedDeficiencyStatus').value = member.deficiencyStatus || '';

      document.getElementById('selectedMember').classList.add('show');
      
      // ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
      setButtonsEnabled(true);

      // â˜… DUPLICATE_DELETED ã®ã¿ç”Ÿæˆãƒ»ä¸å‚™é€£çµ¡ãƒœã‚¿ãƒ³ï¼†ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ç„¡åŠ¹åŒ–
      const s = (member.status || '').toUpperCase();
      const isDisabled = (s === 'DUPLICATE_DELETED');
      if (isDisabled) {
        document.getElementById('btnCard').disabled = true;
        document.getElementById('btnApplication').disabled = true;
        document.getElementById('btnBoth').disabled = true;
        document.getElementById('btnDeficiency').disabled = true;
      }
      document.getElementById('selectedCardCheck').disabled = isDisabled;
      document.getElementById('selectedAppCheck').disabled = isDisabled;
    }
    
    function setButtonsEnabled(enabled) {
      document.getElementById('btnDetail').disabled = !enabled;
      document.getElementById('btnCard').disabled = !enabled;
      document.getElementById('btnApplication').disabled = !enabled;
      document.getElementById('btnBoth').disabled = !enabled;
      document.getElementById('btnDeficiency').disabled = !enabled;
      document.getElementById('btnDuplicate').disabled = !enabled;
      document.getElementById('btnCheckKaihipay').disabled = !enabled;
      document.getElementById('btnRetryKaihipay').disabled = !enabled;
    }
    
    // å°åˆ·å›æ•°è¡¨ç¤ºã‚’æ›´æ–°
function updateListPrintCount(index, cardCount, appCount) {
  const items = document.querySelectorAll('.result-item');
  if (items[index]) {
    if (cardCount !== undefined) {
      const cardCb = items[index].querySelector('.card-count .print-checkbox');
      if (cardCb) cardCb.checked = cardCount > 0;
    }
    if (appCount !== undefined) {
      const appCb = items[index].querySelector('.app-count .print-checkbox');
      if (appCb) appCb.checked = appCount > 0;
    }
  }
}
    
    function getStatusClass(status) {
      if (!status) return 'status-pending';
      const s = status.toUpperCase();
      if (s === 'ACTIVE') return 'status-active';
      if (s === 'INACTIVE') return 'status-inactive';
      if (s === 'DUPLICATE_DELETED') return 'status-duplicate-deleted';
      return 'status-pending';
    }

    function getStatusText(status) {
      if (!status) return 'æœªè¨­å®š';
      const s = status.toUpperCase();
      if (s === 'ACTIVE') return 'æœ‰åŠ¹';
      if (s === 'INACTIVE') return 'ç„¡åŠ¹';
      if (s === 'DUPLICATE_DELETED') return 'äºŒé‡å‰Šé™¤';
      return status;
    }
    
    function escapeHtml(str) {
      if (!str) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }
    
    // ========== ä¼šå“¡è©³ç´°ã‚’åˆ¥çª“ã§é–‹ã ========== //
    
    function openMemberDetail() {
      if (!selectedMemberData) {
        showMessage('ä¼šå“¡ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
        return;
      }
      
      // ä¼šå“¡è©³ç´°ãƒšãƒ¼ã‚¸ã‚’åˆ¥çª“ã§é–‹ã
      const url = `${MEMBER_DETAIL_URL}?row=${selectedMemberData.rowNumber}&member_id=${encodeURIComponent(selectedMemberData.memberId)}`;
      window.open(url, '_blank', 'width=900,height=800,scrollbars=yes,resizable=yes');
    }
    
    // ========== ã‚«ãƒ¼ãƒ‰ãƒ»ç”³è«‹æ›¸ç”Ÿæˆ ========== //
    
    async function generateCard() {
      if (!selectedMemberData) {
        showMessage('ä¼šå“¡ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
        return;
      }
      
      showLoading(true);
      hideMessage();
      
      try {
        const result = await callApi('generateCardByRow', { rowNumber: selectedMemberData.rowNumber });
        showLoading(false);
        
        if (result.success) {
          // â˜… å°åˆ·å›æ•°ã‚’æ›´æ–°
          const selectedIndex = Array.from(document.querySelectorAll('.result-item')).findIndex(item => item.classList.contains('selected'));
          if (selectedIndex >= 0 && result.cardPrintCount !== undefined) {
            updateListPrintCount(selectedIndex, result.cardPrintCount, undefined);
            document.getElementById('selectedCardCheck').checked = true;
          }
          
          showSuccessWithLink(
            `âœ… ã‚«ãƒ¼ãƒ‰ç”Ÿæˆå®Œäº†\n\n` +
            `ä¼šå“¡ç•ªå·: ${result.memberId}\n` +
            `åº—å: ${result.storeName}\n` +
            `ç€ç”¨è€…: ${result.wearerName}\n` +
            `ã‚«ãƒ¼ãƒ‰å°åˆ·å›æ•°: ${result.cardPrintCount || 1}å›ç›®`,
            result.slideUrl,
            'ğŸ« ã‚«ãƒ¼ãƒ‰ã‚’é–‹ã'
          );
        } else {
          showMessage('âŒ ã‚¨ãƒ©ãƒ¼: ' + result.error, 'error');
        }
      } catch (error) {
        showLoading(false);
        showMessage('âŒ ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
      }
    }
    
    async function generateApplication() {
      if (!selectedMemberData) {
        showMessage('ä¼šå“¡ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
        return;
      }
      
      showLoading(true);
      hideMessage();
      
      try {
        const result = await callApi('generateApplicationFormByRow', { rowNumber: selectedMemberData.rowNumber });
        showLoading(false);
        
        if (result.success) {
          // â˜… å°åˆ·å›æ•°ã‚’æ›´æ–°
          const selectedIndex = Array.from(document.querySelectorAll('.result-item')).findIndex(item => item.classList.contains('selected'));
          if (selectedIndex >= 0 && result.appPrintCount !== undefined) {
            updateListPrintCount(selectedIndex, undefined, result.appPrintCount);
            document.getElementById('selectedAppCheck').checked = true;
          }
          
          showSuccessWithLink(
            `âœ… ç”³è«‹æ›¸ç”Ÿæˆå®Œäº†\n\n` +
            `ä¼šå“¡ç•ªå·: ${result.memberId}\n` +
            `åº—å: ${result.storeName}\n` +
            `ç”³è«‹æ›¸å°åˆ·å›æ•°: ${result.appPrintCount || 1}å›ç›®`,
            result.slideUrl,
            'ğŸ“‹ ç”³è«‹æ›¸ã‚’é–‹ã'
          );
        } else {
          showMessage('âŒ ã‚¨ãƒ©ãƒ¼: ' + result.error, 'error');
        }
      } catch (error) {
        showLoading(false);
        showMessage('âŒ ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
      }
    }
    
    async function generateBoth() {
      if (!selectedMemberData) {
        showMessage('ä¼šå“¡ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
        return;
      }
      
      showLoading(true);
      hideMessage();
      
      try {
        const rowNumber = selectedMemberData.rowNumber;
        
        // ç”³è«‹æ›¸ã¨ã‚«ãƒ¼ãƒ‰ã‚’ä¸¦åˆ—ã§ç”Ÿæˆ
        const [appResult, cardResult] = await Promise.all([
          callApi('generateApplicationFormByRow', { rowNumber }),
          callApi('generateCardByRow', { rowNumber })
        ]);
        
        showLoading(false);
        
        if (appResult.success && cardResult.success) {
          // â˜… å°åˆ·å›æ•°ã‚’æ›´æ–°
          const selectedIndex = Array.from(document.querySelectorAll('.result-item')).findIndex(item => item.classList.contains('selected'));
          if (selectedIndex >= 0) {
            updateListPrintCount(selectedIndex, cardResult.cardPrintCount, appResult.appPrintCount);
            if (cardResult.cardPrintCount !== undefined) {
              document.getElementById('selectedCardCheck').checked = true;
            }
            if (appResult.appPrintCount !== undefined) {
              document.getElementById('selectedAppCheck').checked = true;
            }
          }
          
          showSuccessWithLinks(
            `âœ… ç”³è«‹æ›¸ï¼‹ã‚«ãƒ¼ãƒ‰ç”Ÿæˆå®Œäº†\n\nä¼šå“¡ç•ªå·: ${appResult.memberId}\nã‚«ãƒ¼ãƒ‰å°åˆ·: ${cardResult.cardPrintCount || 1}å›ç›® / ç”³è«‹æ›¸å°åˆ·: ${appResult.appPrintCount || 1}å›ç›®`,
            [
              { url: appResult.slideUrl, label: 'ğŸ“‹ ç”³è«‹æ›¸ã‚’é–‹ã' },
              { url: cardResult.slideUrl, label: 'ğŸ« ã‚«ãƒ¼ãƒ‰ã‚’é–‹ã' }
            ]
          );
        } else {
          const errors = [];
          if (!appResult.success) errors.push('ç”³è«‹æ›¸: ' + appResult.error);
          if (!cardResult.success) errors.push('ã‚«ãƒ¼ãƒ‰: ' + cardResult.error);
          showMessage('âŒ ã‚¨ãƒ©ãƒ¼:\n' + errors.join('\n'), 'error');
        }
      } catch (error) {
        showLoading(false);
        showMessage('âŒ ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
      }
    }
    
    // ========== ä¸€æ‹¬å‡¦ç† ========== //
    
    async function generateTestCard() {
      showLoading(true);
      hideMessage();
      
      try {
        const result = await callApi('generateTestCard');
        showLoading(false);
        
        if (result.success) {
          showSuccessWithLink(
            `âœ… ãƒ†ã‚¹ãƒˆã‚«ãƒ¼ãƒ‰ç”Ÿæˆå®Œäº†\n\n` +
            `ä¼šå“¡ç•ªå·: ${result.memberId}\n` +
            `åº—å: ${result.storeName}\n` +
            `ç€ç”¨è€…: ${result.wearerName}`,
            result.slideUrl,
            'ğŸ« ãƒ†ã‚¹ãƒˆã‚«ãƒ¼ãƒ‰ã‚’é–‹ã'
          );
        } else {
          showMessage('âŒ ã‚¨ãƒ©ãƒ¼: ' + result.error, 'error');
        }
      } catch (error) {
        showLoading(false);
        showMessage('âŒ ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
      }
    }
    
    async function generateAllCards() {
      if (!confirm('å…¨ãƒ‡ãƒ¼ã‚¿ã®ã‚«ãƒ¼ãƒ‰ã‚’ä¸€æ‹¬ç”Ÿæˆã—ã¾ã™ã‹ï¼Ÿ\næ™‚é–“ãŒã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚')) {
        return;
      }
      
      showLoading(true);
      hideMessage();
      
      try {
        const result = await callApi('generateAllCards');
        showLoading(false);
        
        if (result.success) {
          showMessage(
            `âœ… ä¸€æ‹¬ç”Ÿæˆå®Œäº†\n\næˆåŠŸ: ${result.successCount}ä»¶\nã‚¨ãƒ©ãƒ¼: ${result.errorCount}ä»¶`,
            'success'
          );
        } else {
          showMessage('âŒ ã‚¨ãƒ©ãƒ¼: ' + result.error, 'error');
        }
      } catch (error) {
        showLoading(false);
        showMessage('âŒ ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
      }
    }
    
    async function generateAllApplications() {
      if (!confirm('å…¨ãƒ‡ãƒ¼ã‚¿ã®ç”³è«‹æ›¸ã‚’ä¸€æ‹¬ç”Ÿæˆã—ã¾ã™ã‹ï¼Ÿ\næ™‚é–“ãŒã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚')) {
        return;
      }
      
      showLoading(true);
      hideMessage();
      
      try {
        const result = await callApi('generateAllApplicationForms');
        showLoading(false);
        
        if (result.success) {
          showMessage(
            `âœ… ä¸€æ‹¬ç”Ÿæˆå®Œäº†\n\næˆåŠŸ: ${result.successCount}ä»¶\nã‚¨ãƒ©ãƒ¼: ${result.errorCount}ä»¶`,
            'success'
          );
        } else {
          showMessage('âŒ ã‚¨ãƒ©ãƒ¼: ' + result.error, 'error');
        }
      } catch (error) {
        showLoading(false);
        showMessage('âŒ ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
      }
    }
    
    // ========== UI ãƒ˜ãƒ«ãƒ‘ãƒ¼ ========== //
    
    function showLoading(show) {
      document.getElementById('loading').style.display = show ? 'block' : 'none';
    }
    
    function showMessage(text, type) {
      const messageEl = document.getElementById('message');
      messageEl.textContent = text;
      messageEl.className = 'message ' + type;
      messageEl.style.display = 'block';
    }
    
    function hideMessage() {
      document.getElementById('message').style.display = 'none';
    }
    
    function showSuccessWithLink(text, url, linkLabel) {
      const messageEl = document.getElementById('message');
      messageEl.innerHTML = '';
      messageEl.className = 'message success';
      
      const textNode = document.createElement('div');
      textNode.style.whiteSpace = 'pre-line';
      textNode.textContent = text;
      messageEl.appendChild(textNode);
      
      const link = document.createElement('div');
      link.className = 'result-link';
      link.innerHTML = `<a href="${url}" target="_blank">${linkLabel}</a>`;
      messageEl.appendChild(link);
      
      messageEl.style.display = 'block';
    }
    
    function showSuccessWithLinks(text, links) {
      const messageEl = document.getElementById('message');
      messageEl.innerHTML = '';
      messageEl.className = 'message success';
      
      const textNode = document.createElement('div');
      textNode.style.whiteSpace = 'pre-line';
      textNode.textContent = text;
      messageEl.appendChild(textNode);
      
      links.forEach(function(linkInfo) {
        const link = document.createElement('div');
        link.className = 'result-link';
        link.innerHTML = `<a href="${linkInfo.url}" target="_blank">${linkInfo.label}</a>`;
        messageEl.appendChild(link);
      });
      
      messageEl.style.display = 'block';
    }
    
    // ========== åˆæœŸåŒ– ========== //
    
    function initializePage() {
      // æœ€æ–°20ä»¶ã‚’è‡ªå‹•ãƒ­ãƒ¼ãƒ‰
      loadRecentMembers(1);
      // â˜… å†æå‡ºã‚¢ãƒ©ãƒ¼ãƒˆãƒã‚§ãƒƒã‚¯
      checkResubmitAlert();
    }
    
    window.onload = function() {
      // èªè¨¼ãƒã‚§ãƒƒã‚¯
      if (!checkAuthentication()) {
        return; // èªè¨¼ã•ã‚Œã¦ã„ãªã„å ´åˆã¯åˆæœŸåŒ–ã‚’ä¸­æ­¢
      }
      initializePage();
    };

    // ========== ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã§ã®å°åˆ·çŠ¶æ…‹åˆ‡ã‚Šæ›¿ãˆ ========== //

async function togglePrintStatus(index, type, checkbox) {
  const member = window.searchResultsData[index];
  if (!member) return;

  const newValue = checkbox.checked ? 1 : 0;

  try {
    const result = await callApi('updatePrintStatus', {
      rowNumber: member.rowNumber,
      type: type,
      value: newValue
    });

    if (result.success) {
      // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚‚æ›´æ–°
      if (type === 'card') {
        member.cardPrintCount = newValue;
      } else {
        member.appPrintCount = newValue;
      }

      // é¸æŠä¸­ã®ä¼šå“¡ã®è¡¨ç¤ºã‚‚åŒæœŸ
      if (selectedMemberData && selectedMemberData.rowNumber === member.rowNumber) {
        if (type === 'card') {
          document.getElementById('selectedCardCheck').checked = checkbox.checked;
        } else {
          document.getElementById('selectedAppCheck').checked = checkbox.checked;
        }
      }
    } else {
      // å¤±æ•—æ™‚ã¯ãƒã‚§ãƒƒã‚¯ã‚’æˆ»ã™
      checkbox.checked = !checkbox.checked;
      showMessage('âŒ æ›´æ–°å¤±æ•—: ' + result.error, 'error');
    }
  } catch (error) {
    checkbox.checked = !checkbox.checked;
    showMessage('âŒ ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
  }
}

function toggleSelectedPrintStatus(type, checkbox) {
  if (!selectedMemberData) return;

  const index = window.searchResultsData.findIndex(m => m.rowNumber === selectedMemberData.rowNumber);
  if (index >= 0) {
    // ä¸€è¦§å´ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚‚åŒæœŸ
    const items = document.querySelectorAll('.result-item');
    const selector = type === 'card' ? '.card-count .print-checkbox' : '.app-count .print-checkbox';
    const listCheckbox = items[index]?.querySelector(selector);
    if (listCheckbox) listCheckbox.checked = checkbox.checked;
  }

  togglePrintStatus(
    index >= 0 ? index : 0,
    type,
    checkbox
  );
}
// ========== è§£ç´„æ¸ˆã¿ã«ã™ã‚‹ï¼ˆç®¡ç†è€…æ“ä½œï¼‰ ========== //

async function completeCancelAction() {
  if (!selectedMemberData) {
    showMessage('ä¼šå“¡ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
    return;
  }

  const memberId = selectedMemberData.memberId;
  const storeName = selectedMemberData.storeName;

  if (!confirm(
    `ã€è§£ç´„å®Œäº†å‡¦ç†ã€‘\n\n` +
    `ä¼šå“¡ç•ªå·: ${memberId}\n` +
    `åº—å: ${storeName}\n\n` +
    `è§£ç´„æ¸ˆã¿ã«ã—ã¾ã™ã‹ï¼Ÿ\n` +
    `â€» ä¼šå“¡ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒã€Œç„¡åŠ¹ã€ã«ãªã‚Šã€è§£ç´„å®Œäº†ãƒ¡ãƒ¼ãƒ«ãŒé€ä¿¡ã•ã‚Œã¾ã™ã€‚\n` +
    `â€» æ±ºæ¸ˆåœæ­¢å‡¦ç†ãŒå®Œäº†ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`
  )) {
    return;
  }

  // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
  const btn = document.querySelector('.btn-complete-cancel');
  if (btn) {
    btn.disabled = true;
    btn.textContent = 'å‡¦ç†ä¸­...';
  }

  showLoading(true);
  hideMessage();

  try {
    const result = await callApi('completeCancel', {
      rowNumber: selectedMemberData.rowNumber,
      memberId: memberId
    });

    showLoading(false);

    if (result.success) {
      showMessage('âœ… ' + result.message + '\nè§£ç´„å®Œäº†ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚', 'success');

      // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
      selectedMemberData.cancelStatus = 'è§£ç´„æ¸ˆã¿';
      selectedMemberData.status = 'INACTIVE';

      // é¸æŠä¸­ã®è¡¨ç¤ºã‚’æ›´æ–°
      document.getElementById('selectedCancelStatusArea').innerHTML = getCancelBadgeLg('è§£ç´„æ¸ˆã¿');
      document.getElementById('selectedStatus').textContent = 'ç„¡åŠ¹';

      // ä¸€è¦§å´ã®ãƒãƒƒã‚¸ã‚‚æ›´æ–°
      const index = window.searchResultsData.findIndex(m => m.rowNumber === selectedMemberData.rowNumber);
      if (index >= 0) {
        window.searchResultsData[index].cancelStatus = 'è§£ç´„æ¸ˆã¿';
        window.searchResultsData[index].status = 'INACTIVE';
        const items = document.querySelectorAll('.result-item');
        if (items[index]) {
          const storeNameEl = items[index].querySelector('.result-store-name');
          if (storeNameEl) {
            storeNameEl.innerHTML = escapeHtml(storeName) + getCancelBadge('è§£ç´„æ¸ˆã¿');
          }
          const statusEl = items[index].querySelector('.result-status');
          if (statusEl) {
            statusEl.className = 'result-status status-inactive';
            statusEl.textContent = 'ç„¡åŠ¹';
          }
        }
      }
    } else {
      showMessage('âŒ ã‚¨ãƒ©ãƒ¼: ' + result.error, 'error');
      if (btn) {
        btn.disabled = false;
        btn.textContent = 'âœ” è§£ç´„æ¸ˆã¿ã«ã™ã‚‹';
      }
    }
  } catch (error) {
    showLoading(false);
    showMessage('âŒ ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
    if (btn) {
      btn.disabled = false;
      btn.textContent = 'âœ” è§£ç´„æ¸ˆã¿ã«ã™ã‚‹';
    }
  }
}

    function setButtonsEnabled(enabled) {
  document.getElementById('btnDetail').disabled = !enabled;
  document.getElementById('btnCard').disabled = !enabled;
  document.getElementById('btnApplication').disabled = !enabled;
  document.getElementById('btnBoth').disabled = !enabled;
  document.getElementById('btnDeficiency').disabled = !enabled;
  document.getElementById('btnDuplicate').disabled = !enabled;
  document.getElementById('btnCheckKaihipay').disabled = !enabled;
  document.getElementById('btnRetryKaihipay').disabled = !enabled;
}

// ========== ä¼šè²»ãƒšã‚¤å†ç™»éŒ² ========== //
async function retryKaihipayRegistration() {
  if (!selectedMemberData || !selectedMemberData.memberId) {
    alert('ä¼šå“¡ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“');
    return;
  }

  const memberId = selectedMemberData.memberId;
  const storeName = selectedMemberData.storeName || '';

  if (!confirm(
    memberId + ' ' + storeName + ' ã®ä¼šè²»ãƒšã‚¤ç™»éŒ²ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ\n\n' +
    'å‡¦ç†å†…å®¹:\n' +
    '1. ä¼šè²»ãƒšã‚¤ã«ä¼šå“¡ç™»éŒ²ï¼ˆæœªç™»éŒ²ã®å ´åˆï¼‰\n' +
    '2. ã‚³ãƒ¼ã‚¹è¿½åŠ ï¼ˆæœªè¿½åŠ ã®å ´åˆï¼‰\n' +
    '3. æ”¯æ‰•ã„æ¡ˆå†…ãƒ¡ãƒ¼ãƒ«ãŒä¼šå“¡ã«è‡ªå‹•é€ä¿¡ã•ã‚Œã¾ã™'
  )) {
    return;
  }

  const btn = document.getElementById('btnRetryKaihipay');
  const originalText = btn.textContent;
  btn.disabled = true;
  btn.textContent = 'â³ å‡¦ç†ä¸­...';
  btn.style.opacity = '0.6';

  try {
    const result = await callApi('retryKaihipayRegistration', {
      memberId: memberId
    });

    if (result.success) {
      const stepsText = (result.steps || []).join('\n');
      alert(
        'âœ… ä¼šè²»ãƒšã‚¤ç™»éŒ²æˆåŠŸï¼\n\n' +
        'ä¼šå“¡ç•ªå·: ' + result.memberId + '\n' +
        'åº—å: ' + result.storeName + '\n\n' +
        'å‡¦ç†çµæœ:\n' + stepsText + '\n\n' +
        'ä¼šå“¡ã«æ”¯æ‰•ã„æ¡ˆå†…ãƒ¡ãƒ¼ãƒ«ãŒé€ä¿¡ã•ã‚Œã¾ã™ã€‚'
      );
    } else {
      alert('âŒ ä¼šè²»ãƒšã‚¤ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ\n\n' + (result.error || result.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
    }

  } catch (error) {
    alert('âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼: ' + error.message);
  } finally {
    btn.disabled = false;
    btn.textContent = originalText;
    btn.style.opacity = '1';
  }
}

// ========== ä¼šè²»ãƒšã‚¤çŠ¶æ…‹ç¢ºèª ========== //
async function checkKaihipayStatus() {
  if (!selectedMemberData || !selectedMemberData.memberId) {
    alert('ä¼šå“¡ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“');
    return;
  }

  const memberId = selectedMemberData.memberId;

  const btn = document.getElementById('btnCheckKaihipay');
  const originalText = btn.textContent;
  btn.disabled = true;
  btn.textContent = 'ğŸ” ç¢ºèªä¸­...';

  try {
    const result = await callApi('checkKaihipayStatus', {
      memberId: memberId
    });

    if (result.success) {
      if (result.registered) {
        const cd = result.customerData || {};
        const courses = (cd.courses || []).map(function(c) { return c.course_name || c.course_id; }).join(', ') || 'ãªã—';

        alert(
          'âœ… ä¼šè²»ãƒšã‚¤ã«ç™»éŒ²æ¸ˆã¿\n\n' +
          'ä¼šå“¡ç•ªå·: ' + cd.customer_number + '\n' +
          'æ°å: ' + cd.name + '\n' +
          'ãƒ¡ãƒ¼ãƒ«: ' + cd.mail + '\n' +
          'æ”¯æ‰•æ–¹æ³•: ' + cd.payment_method_type + '\n' +
          'ã‚³ãƒ¼ã‚¹: ' + courses + '\n\n' +
          (result.hasPaymentMethod
            ? 'æ”¯æ‰•æ–¹æ³•ã‚‚ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚'
            : 'âš ï¸ æ”¯æ‰•æ–¹æ³•ãŒæœªç™»éŒ²ã§ã™ã€‚ä¼šå“¡ã«æ¡ˆå†…ãƒ¡ãƒ¼ãƒ«ãŒå±Šã„ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚')
        );
      } else {
        alert(
          'âŒ ä¼šè²»ãƒšã‚¤ã«æœªç™»éŒ²\n\n' +
          memberId + ' ã¯ä¼šè²»ãƒšã‚¤ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\n' +
          'ã€ŒğŸ’³ ä¼šè²»ãƒšã‚¤å†ç™»éŒ²ã€ãƒœã‚¿ãƒ³ã§ç™»éŒ²ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚'
        );
      }
    } else {
      alert('âŒ ç¢ºèªã«å¤±æ•—ã—ã¾ã—ãŸ\n\n' + (result.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
    }

  } catch (error) {
    alert('âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼: ' + error.message);
  } finally {
    btn.disabled = false;
    btn.textContent = originalText;
  }
}

// ========== äºŒé‡ç™»éŒ²å‰Šé™¤ ========== //
async function deleteDuplicateMember() {
  if (!selectedMemberData) return;

  const memberId = selectedMemberData.memberId;
  const storeName = selectedMemberData.storeName;

  if (!confirm(`ã€äºŒé‡ç™»éŒ²å‰Šé™¤ã€‘\n\nä¼šå“¡ç•ªå·: ${memberId}\nåº—å: ${storeName}\n\nã“ã®ä¼šå“¡ã‚’äºŒé‡ç™»éŒ²ã¨ã—ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nâ€» ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒã€ŒäºŒé‡å‰Šé™¤ã€ã«å¤‰æ›´ã•ã‚Œã¾ã™ã€‚`)) {
    return;
  }

  const btn = document.getElementById('btnDuplicate');
  btn.disabled = true;
  btn.textContent = 'å‡¦ç†ä¸­...';

  try {
    const result = await callApi('deleteDuplicate', {
      rowNumber: selectedMemberData.rowNumber
    });

    if (result.success) {
      showMessage('âœ… äºŒé‡ç™»éŒ²ã‚’å‰Šé™¤ã—ã¾ã—ãŸï¼ˆ' + memberId + 'ï¼‰', 'success');

      // é¸æŠä¸­ã®ä¼šå“¡ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
      selectedMemberData.status = 'DUPLICATE_DELETED';
      document.getElementById('selectedStatus').textContent = 'äºŒé‡å‰Šé™¤';
      document.getElementById('selectedStatus').className = 'result-status status-duplicate-deleted';

      // ãƒªã‚¹ãƒˆä¸Šã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚‚æ›´æ–°
      const index = selectedMemberData._listIndex;
      if (index !== undefined && window.searchResultsData) {
        window.searchResultsData[index].status = 'DUPLICATE_DELETED';
        const items = document.querySelectorAll('.result-item');
        if (items[index]) {
          const statusEl = items[index].querySelector('.result-status');
          if (statusEl) {
            statusEl.textContent = 'äºŒé‡å‰Šé™¤';
            statusEl.className = 'result-status status-duplicate-deleted';
          }
        }
      }
    } else {
      showMessage('âŒ ã‚¨ãƒ©ãƒ¼: ' + result.error, 'error');
    }
  } catch (error) {
    showMessage('âŒ ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
  } finally {
    btn.disabled = false;
    btn.textContent = 'ğŸ—‘ äºŒé‡ç™»éŒ²å‰Šé™¤';
  }
}

// ========== ä¸å‚™ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ ========== //

async function updateDeficiencyStatus(newStatus) {
  if (!selectedMemberData) return;

  const memberId = selectedMemberData.memberId;
  const dropdown = document.getElementById('selectedDeficiencyStatus');
  const oldStatus = selectedMemberData.deficiencyStatus || '';

  try {
    const result = await callApi('updateDeficiencyStatus', {
      memberId: memberId,
      newStatus: newStatus
    });

    if (result.success) {
      // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
      selectedMemberData.deficiencyStatus = newStatus;

      // ä¸€è¦§å´ã®ãƒãƒƒã‚¸ã‚‚ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°
      const index = window.searchResultsData.findIndex(m => m.rowNumber === selectedMemberData.rowNumber);
      if (index >= 0) {
        window.searchResultsData[index].deficiencyStatus = newStatus;
        const items = document.querySelectorAll('.result-item');
        if (items[index]) {
          const storeNameEl = items[index].querySelector('.result-store-name');
          if (storeNameEl) {
            const cancelStatus = selectedMemberData.cancelStatus || '';
            storeNameEl.innerHTML = escapeHtml(selectedMemberData.storeName)
              + getCancelBadge(cancelStatus)
              + getDeficiencyBadge(newStatus);
          }
        }
      }
    } else {
      // å¤±æ•—æ™‚ã¯å…ƒã«æˆ»ã™
      dropdown.value = oldStatus;
      showMessage('âŒ ä¸å‚™ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°å¤±æ•—: ' + result.error, 'error');
    }
  } catch (error) {
    dropdown.value = oldStatus;
    showMessage('âŒ ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
  }
}

// ========== ä¸å‚™é€£çµ¡ãƒ¢ãƒ¼ãƒ€ãƒ« ========== //
function openDeficiencyModal() {
  if (!selectedMemberData) {
    alert('ä¼šå“¡ã‚’é¸æŠã—ã¦ãã ã•ã„');
    return;
  }

  const member = selectedMemberData;
  const overlay = document.createElement('div');
  overlay.className = 'deficiency-modal-overlay';
  overlay.id = 'deficiencyModalOverlay';
  overlay.innerHTML = `
    <div class="deficiency-modal">
      <h3>âš ï¸ æ›¸é¡ä¸å‚™é€£çµ¡</h3>
      <div class="step-indicator">
        <div class="step-dot active" id="stepDot1"></div>
        <div class="step-dot" id="stepDot2"></div>
      </div>

      <!-- STEP 1: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼†ç·¨é›† -->
      <div class="deficiency-step active" id="defStep1">
        <div class="member-summary">
          <strong>${escapeHtml(member.memberId)}</strong> - 
          ${escapeHtml(member.storeName)} / 
          ${escapeHtml(member.wearerName)}<br>
          ğŸ“§ ${escapeHtml(member.email || 'æœªç™»éŒ²')}
        </div>

        <div class="form-group">
          <label>ä¸å‚™ã®ç®‡æ‰€</label>
          <select id="deficiencyTypeSelect" onchange="onDeficiencyTypeChange(this.value)" style="width:100%; padding:10px 12px; border:1px solid #ddd; border-radius:8px; font-size:14px; font-family:inherit;">
            <option value="photo">é¡”å†™çœŸ</option>
            <option value="doc">å…¬çš„æ›¸é¡</option>
            <option value="both" selected>é¡”å†™çœŸãŠã‚ˆã³å…¬çš„æ›¸é¡</option>
          </select>
        </div>

        <div id="previewLoading" style="text-align:center; padding:24px; color:#666;">
          ãƒ¡ãƒ¼ãƒ«æ–‡é¢ã‚’ç”Ÿæˆä¸­...
        </div>

        <div id="previewArea" style="display:none;">
          <div class="email-preview-box">
            <div class="preview-to" id="previewTo" style="display:none;"></div>
            <div class="preview-label">ä»¶å</div>
            <input type="text" class="preview-subject" id="previewSubject">
            <div class="preview-label">æœ¬æ–‡ï¼ˆç·¨é›†ã§ãã¾ã™ï¼‰</div>
            <textarea class="preview-body" id="previewBody"></textarea>
          </div>
          <div class="modal-buttons">
            <button class="btn-cancel" onclick="document.getElementById('deficiencyModalOverlay').remove()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button class="btn-send" onclick="goToStep(2)">é€ä¿¡ç¢ºèªã¸ â†’</button>
          </div>
        </div>
      </div>

      <!-- STEP 2: æœ€çµ‚ç¢ºèª -->
      <div class="deficiency-step" id="defStep2">
        <div class="confirm-box">
          <div class="confirm-icon">ğŸ“§</div>
          <div class="confirm-text">ä»¥ä¸‹ã®å®›å…ˆã«ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã™</div>
          <div class="confirm-to" id="confirmTo"></div>
        </div>
        <div style="font-size:13px; color:#666; margin:12px 0; text-align:center;">
          é€ä¿¡å¾Œã¯å–ã‚Šæ¶ˆã—ã§ãã¾ã›ã‚“ã€‚<br>
          å†…å®¹ã‚’ä¿®æ­£ã™ã‚‹å ´åˆã¯ã€Œæˆ»ã‚‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚
        </div>
        <div class="modal-buttons">
          <button class="btn-back" onclick="goToStep(1)">â† æˆ»ã‚‹</button>
          <button class="btn-confirm-send" id="btnSendDeficiency" onclick="sendDeficiency()">
            ğŸ“§ é€ä¿¡ã™ã‚‹
          </button>
        </div>
      </div>
    </div>
  `;

  document.body.appendChild(overlay);
  overlay.addEventListener('click', function(e) {
    if (e.target === overlay) overlay.remove();
  });

  // è‡ªå‹•ã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å–å¾—
  loadDeficiencyPreview();
}

let currentDeficiencyType = 'both';

async function onDeficiencyTypeChange(newType) {
  currentDeficiencyType = newType;

  // APIã‚’å†å‘¼ã³å‡ºã—ã—ã¦æ­£ã—ã„ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã§æ–‡é¢ã‚’å†ç”Ÿæˆ
  try {
    document.getElementById('previewBody').value = 'æ–‡é¢ã‚’å†ç”Ÿæˆä¸­...';
    const result = await callApi('previewDeficiencyNotice', {
      memberId: selectedMemberData.memberId,
      deficiencyType: newType,
      deficiencyNote: ''
    });

    if (result.success) {
      document.getElementById('previewSubject').value = result.subject;
      document.getElementById('previewBody').value = result.body;
    }
  } catch (error) {
    console.log('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å†å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
  }
}

async function loadDeficiencyPreview() {
  try {
    const typeSelect = document.getElementById('deficiencyTypeSelect');
    currentDeficiencyType = typeSelect ? typeSelect.value : 'both';

    const result = await callApi('previewDeficiencyNotice', {
      memberId: selectedMemberData.memberId,
      deficiencyType: currentDeficiencyType,
      deficiencyNote: ''
    });

    if (result.success) {
      document.getElementById('previewTo').textContent = result.email;
      document.getElementById('previewSubject').value = result.subject;
      document.getElementById('previewBody').value = result.body;
      document.getElementById('previewLoading').style.display = 'none';
      document.getElementById('previewArea').style.display = 'block';
    } else {
      document.getElementById('previewLoading').textContent =
        'ã‚¨ãƒ©ãƒ¼: ' + (result.error || 'æ–‡é¢ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  } catch (error) {
    document.getElementById('previewLoading').textContent = 'é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
  }
}

function goToStep(step) {
  document.querySelectorAll('.deficiency-step').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.step-dot').forEach(el => {
    el.classList.remove('active');
    el.classList.remove('done');
  });
  document.getElementById('defStep' + step).classList.add('active');
  for (let i = 1; i <= 2; i++) {
    const dot = document.getElementById('stepDot' + i);
    if (i < step) dot.classList.add('done');
    else if (i === step) dot.classList.add('active');
  }
  if (step === 2) {
    document.getElementById('confirmTo').textContent =
      document.getElementById('previewTo').textContent;
  }
}

function closeDeficiencyModal() {
  const overlay = document.getElementById('deficiencyModalOverlay');
  if (overlay) overlay.remove();
}

async function sendDeficiency() {
  if (!selectedMemberData) return;
  const btn = document.getElementById('btnSendDeficiency');
  btn.disabled = true;
  btn.textContent = 'é€ä¿¡ä¸­...';

  try {
    const typeSelect = document.getElementById('deficiencyTypeSelect');
    const result = await callApi('sendDeficiencyNotice', {
      memberId: selectedMemberData.memberId,
      deficiencyType: typeSelect ? typeSelect.value : 'both',
      deficiencyNote: '',
      previewedSubject: document.getElementById('previewSubject').value,
      previewedBody: document.getElementById('previewBody').value
    });

    if (result.success) {
      alert('ä¸å‚™é€£çµ¡ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚\né€ä¿¡å…ˆ: ' + result.email);
      closeDeficiencyModal();
      selectedMemberData.deficiencyStatus = 'ä¸å‚™é€£çµ¡æ¸ˆã¿';
      const searchInput = document.getElementById('searchInput');
      if (searchInput && searchInput.value) {
        document.getElementById('searchBtn').click();
      }
    } else {
      alert('é€ä¿¡ã‚¨ãƒ©ãƒ¼: ' + (result.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
    }
  } catch (error) {
    alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
  } finally {
    btn.disabled = false;
    btn.textContent = 'ğŸ“§ é€ä¿¡ã™ã‚‹';
  }
}
  </script>
</body>
</html>
