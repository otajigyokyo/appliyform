<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è²·å‡ºäººç« ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', 'Noto Sans JP', sans-serif;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }
    
    h1 {
      color: #667eea;
      text-align: center;
      margin-bottom: 10px;
      font-size: 26px;
    }
    
    .subtitle {
      text-align: center;
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }
    
    /* ========== æ¤œç´¢ã‚»ã‚¯ã‚·ãƒ§ãƒ³ ========== */
    .search-section {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      border: 2px solid #667eea;
    }
    
    .search-section h2 {
      font-size: 16px;
      color: #333;
      margin-bottom: 15px;
    }
    
    .search-box {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .search-input {
      flex: 1;
      padding: 12px 15px;
      border: 2px solid #ddd;
      border-radius: 6px;
      font-size: 16px;
      transition: border-color 0.3s;
    }
    
    .search-input:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .search-input::placeholder {
      color: #999;
    }
    
    .btn-search {
      padding: 12px 25px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      white-space: nowrap;
    }
    
    .btn-search:hover {
      background: #5568d3;
    }
    
    .btn-recent {
      padding: 12px 20px;
      background: #6c757d;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s;
      white-space: nowrap;
    }
    
    .btn-recent:hover {
      background: #545b62;
    }
    
    /* ========== æ¤œç´¢çµæœ ========== */
    .search-results {
      margin-top: 15px;
    }
    
    .results-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid #ddd;
    }
    
    .results-count {
      font-size: 14px;
      color: #666;
    }
    
    .results-list {
      max-height: 350px;
      overflow-y: auto;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
    }
    
    .result-item {
      display: flex;
      align-items: center;
      padding: 12px 15px;
      border-bottom: 1px solid #f0f0f0;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .result-item:last-child {
      border-bottom: none;
    }
    
    .result-item:hover {
      background-color: #f5f5f5;
    }
    
    .result-item.selected {
      background-color: #e8f0fe;
      border-left: 4px solid #667eea;
    }
    
    .result-radio {
      margin-right: 12px;
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    
    .result-info {
      flex: 1;
      display: grid;
      grid-template-columns: 100px 1fr 1fr 80px;
      gap: 10px;
      align-items: center;
    }
    
    .result-member-id {
      font-weight: bold;
      color: #667eea;
      font-size: 14px;
    }
    
    .result-store-name {
      font-size: 14px;
      color: #333;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .result-wearer-name {
      font-size: 14px;
      color: #555;
    }
    
    .result-status {
      font-size: 12px;
      padding: 3px 8px;
      border-radius: 4px;
      text-align: center;
    }
    
    .status-active {
      background: #d4edda;
      color: #155724;
    }
    
    .status-inactive {
      background: #f8d7da;
      color: #721c24;
    }
    
    .status-pending {
      background: #fff3cd;
      color: #856404;
    }
    
    /* ========== é¸æŠä¸­ã®ä¼šå“¡ ========== */
    .selected-member {
      background: #e8f0fe;
      border: 2px solid #667eea;
      border-radius: 8px;
      padding: 15px 20px;
      margin: 20px 0;
      display: none;
    }
    
    .selected-member.show {
      display: block;
    }
    
    .selected-member h3 {
      font-size: 14px;
      color: #667eea;
      margin-bottom: 10px;
    }
    
    .selected-info {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      font-size: 15px;
    }
    
    .selected-info span {
      color: #333;
    }
    
    .selected-info strong {
      color: #667eea;
    }
    
    /* ========== ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ ========== */
    .action-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-top: 20px;
    }
    
    .btn {
      padding: 15px 20px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .btn-card {
      background: #667eea;
      color: white;
    }
    
    .btn-card:hover:not(:disabled) {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }
    
    .btn-application {
      background: #28a745;
      color: white;
    }
    
    .btn-application:hover:not(:disabled) {
      background: #218838;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
    }
    
    .btn-both {
      background: #fd7e14;
      color: white;
      grid-column: 1 / -1;
    }
    
    .btn-both:hover:not(:disabled) {
      background: #e96b02;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(253, 126, 20, 0.3);
    }
    
    .btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    
    /* ========== ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ ========== */
    .message {
      padding: 15px;
      margin: 15px 0;
      border-radius: 6px;
      display: none;
    }
    
    .message.success {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }
    
    .message.error {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }
    
    .message.info {
      background: #d1ecf1;
      border: 1px solid #bee5eb;
      color: #0c5460;
    }
    
    /* ========== ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° ========== */
    .loading {
      display: none;
      text-align: center;
      padding: 30px;
    }
    
    .spinner {
      display: inline-block;
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* ========== çµæœãƒªãƒ³ã‚¯ ========== */
    .result-link {
      display: block;
      margin-top: 10px;
      padding: 12px;
      background: #e7f3ff;
      border-radius: 6px;
      text-align: center;
    }
    
    .result-link a {
      color: #0066cc;
      text-decoration: none;
      font-weight: bold;
      font-size: 15px;
    }
    
    .result-link a:hover {
      text-decoration: underline;
    }
    
    /* ========== ä¸€æ‹¬ç”Ÿæˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ ========== */
    .batch-section {
      margin-top: 30px;
      padding-top: 20px;
      border-top: 2px solid #e0e0e0;
    }
    
    .batch-section h3 {
      font-size: 14px;
      color: #666;
      margin-bottom: 15px;
    }
    
    .batch-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .btn-batch {
      padding: 10px 20px;
      background: #6c757d;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .btn-batch:hover {
      background: #545b62;
    }
    
    /* ========== å°åˆ·æ–¹æ³•ãƒ˜ãƒ«ãƒ— ========== */
    .help-box {
      background: #fff3cd;
      border: 1px solid #ffc107;
      padding: 15px;
      border-radius: 6px;
      margin-top: 20px;
      font-size: 13px;
      color: #856404;
    }
    
    .help-box strong {
      display: block;
      margin-bottom: 8px;
    }
    
    /* ========== ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– ========== */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }
      
      .container {
        padding: 20px;
      }
      
      .search-box {
        flex-direction: column;
      }
      
      .result-info {
        grid-template-columns: 1fr;
        gap: 5px;
      }
      
      .action-buttons {
        grid-template-columns: 1fr;
      }
      
      .btn-both {
        grid-column: 1;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ« è²·å‡ºäººç« ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
    <div class="subtitle">ä¼šå“¡æ¤œç´¢ãƒ»ã‚«ãƒ¼ãƒ‰ç”Ÿæˆãƒ»ç”³è«‹æ›¸å°åˆ·</div>
    
    <!-- æ¤œç´¢ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="search-section">
      <h2>ğŸ” ä¼šå“¡æ¤œç´¢</h2>
      <div class="search-box">
        <input type="text" 
               class="search-input" 
               id="searchKeyword" 
               placeholder="ä¼šå“¡ç•ªå·ã€åº—åã€æ°åã§æ¤œç´¢ï¼ˆä¾‹ï¼šK10032ã€éŠ€åº§ã€å±±ç”°ï¼‰"
               onkeypress="handleSearchKeypress(event)">
        <button class="btn-search" onclick="searchMembers()">ğŸ” æ¤œç´¢</button>
        <button class="btn-recent" onclick="loadRecentMembers()">ğŸ“‹ æœ€æ–°20ä»¶</button>
      </div>
      
      <!-- æ¤œç´¢çµæœ -->
      <div class="search-results" id="searchResults" style="display: none;">
        <div class="results-header">
          <span class="results-count" id="resultsCount">0ä»¶</span>
        </div>
        <div class="results-list" id="resultsList">
          <!-- æ¤œç´¢çµæœãŒã“ã“ã«å…¥ã‚‹ -->
        </div>
      </div>
    </div>
    
    <!-- é¸æŠä¸­ã®ä¼šå“¡ -->
    <div class="selected-member" id="selectedMember">
      <h3>ğŸ“Œ é¸æŠä¸­ã®ä¼šå“¡</h3>
      <div class="selected-info">
        <span><strong>ä¼šå“¡ç•ªå·:</strong> <span id="selectedMemberId">-</span></span>
        <span><strong>åº—å:</strong> <span id="selectedStoreName">-</span></span>
        <span><strong>ç€ç”¨è€…:</strong> <span id="selectedWearerName">-</span></span>
        <span><strong>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</strong> <span id="selectedStatus">-</span></span>
      </div>
    </div>
    
    <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
    <div class="action-buttons">
      <button class="btn btn-card" id="btnCard" onclick="generateCard()" disabled>
        ğŸ« è²·å‡ºäººç« ã‚«ãƒ¼ãƒ‰ç”Ÿæˆ
      </button>
      <button class="btn btn-application" id="btnApplication" onclick="generateApplication()" disabled>
        ğŸ“‹ ç”³è«‹æ›¸ç”Ÿæˆ
      </button>
      <button class="btn btn-both" id="btnBoth" onclick="generateBoth()" disabled>
        ğŸ“¦ ç”³è«‹æ›¸ ï¼‹ ã‚«ãƒ¼ãƒ‰ ä¸¡æ–¹ç”Ÿæˆ
      </button>
    </div>
    
    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
    <div class="loading" id="loading">
      <div class="spinner"></div>
      <div style="margin-top: 10px;">å‡¦ç†ä¸­...</div>
    </div>
    
    <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
    <div class="message" id="message"></div>
    
    <!-- å°åˆ·æ–¹æ³•ãƒ˜ãƒ«ãƒ— -->
    <div class="help-box">
      <strong>ğŸ’¾ PDFå°åˆ·æ–¹æ³•ï¼š</strong>
      1. ç”Ÿæˆã•ã‚ŒãŸãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯<br>
      2. ã€Œãƒ•ã‚¡ã‚¤ãƒ«ã€â†’ã€Œãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€â†’ã€ŒPDFã€ã‚’é¸æŠ<br>
      3. ã‚«ãƒ¼ãƒ‰: B5ç¸¦ã§å°åˆ·ï¼ˆä¸Šéƒ¨55mmã«ã‚«ãƒ¼ãƒ‰ï¼‰ / ç”³è«‹æ›¸: A4ç¸¦ã§å°åˆ·
    </div>
    
    <!-- ä¸€æ‹¬ç”Ÿæˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="batch-section">
      <h3>âš™ï¸ ä¸€æ‹¬å‡¦ç†ãƒ»ãƒ†ã‚¹ãƒˆ</h3>
      <div class="batch-buttons">
        <button class="btn-batch" onclick="generateTestCard()">ğŸ§ª ãƒ†ã‚¹ãƒˆã‚«ãƒ¼ãƒ‰ç”Ÿæˆ</button>
        <button class="btn-batch" onclick="generateAllCards()">ğŸ“Š å…¨ã‚«ãƒ¼ãƒ‰ä¸€æ‹¬ç”Ÿæˆ</button>
        <button class="btn-batch" onclick="generateAllApplications()">ğŸ“Š å…¨ç”³è«‹æ›¸ä¸€æ‹¬ç”Ÿæˆ</button>
      </div>
    </div>
  </div>
  
  <script>
    // â˜… GAS API URLï¼ˆãƒ‡ãƒ—ãƒ­ã‚¤URLã‚’è¨­å®šï¼‰
    const API_URL = 'https://script.google.com/macros/s/AKfycbwbbyZoRzhWu8Ft5xVvyI1LJc7_RLZaeLwVGapXnlYIIJBUSlgJXQTzofwuLl5nux43kg/exec';
    
    // é¸æŠä¸­ã®ä¼šå“¡ãƒ‡ãƒ¼ã‚¿
    let selectedMemberData = null;
    
    // ========== APIå‘¼ã³å‡ºã—å…±é€šé–¢æ•° ========== //
    async function callApi(action, data = {}) {
      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'text/plain',
          },
          body: JSON.stringify({ action, ...data })
        });
        return await response.json();
      } catch (error) {
        console.error('APIå‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼:', error);
        throw error;
      }
    }
    
    // ========== æ¤œç´¢æ©Ÿèƒ½ ========== //
    
    function handleSearchKeypress(event) {
      if (event.key === 'Enter') {
        searchMembers();
      }
    }
    
    async function searchMembers() {
      const keyword = document.getElementById('searchKeyword').value.trim();
      
      if (!keyword) {
        showMessage('æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
        return;
      }
      
      showLoading(true);
      hideMessage();
      
      try {
        const result = await callApi('searchMembers', { keyword });
        showLoading(false);
        
        if (result.success) {
          displaySearchResults(result.results, result.message);
        } else {
          showMessage('âŒ ' + result.error, 'error');
        }
      } catch (error) {
        showLoading(false);
        showMessage('âŒ ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
      }
    }
    
    async function loadRecentMembers() {
      showLoading(true);
      hideMessage();
      
      try {
        const result = await callApi('getRecentMembers', { count: 20 });
        showLoading(false);
        
        if (result.success) {
          displaySearchResults(result.results, result.message);
        } else {
          showMessage('âŒ ' + result.error, 'error');
        }
      } catch (error) {
        showLoading(false);
        showMessage('âŒ ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
      }
    }
    
    function displaySearchResults(results, message) {
      const resultsSection = document.getElementById('searchResults');
      const resultsCount = document.getElementById('resultsCount');
      const resultsList = document.getElementById('resultsList');
      
      resultsCount.textContent = message || `${results.length}ä»¶`;
      
      if (results.length === 0) {
        resultsList.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">è©²å½“ã™ã‚‹ä¼šå“¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div>';
      } else {
        let html = '';
        results.forEach(function(member, index) {
          const statusClass = getStatusClass(member.status);
          const statusText = getStatusText(member.status);
          
          html += `
            <div class="result-item" onclick="selectMember(${index})" data-index="${index}">
              <input type="radio" name="member" class="result-radio">
              <div class="result-info">
                <span class="result-member-id">${escapeHtml(member.memberId)}</span>
                <span class="result-store-name" title="${escapeHtml(member.storeName)}">${escapeHtml(member.storeName)}</span>
                <span class="result-wearer-name">${escapeHtml(member.wearerName)}</span>
                <span class="result-status ${statusClass}">${statusText}</span>
              </div>
            </div>
          `;
        });
        resultsList.innerHTML = html;
      }
      
      resultsSection.style.display = 'block';
      
      // æ¤œç´¢çµæœã‚’ä¿å­˜
      window.searchResults = results;
      
      // é¸æŠã‚’ã‚¯ãƒªã‚¢
      clearSelection();
    }
    
    function selectMember(index) {
      const results = window.searchResults;
      if (!results || index >= results.length) return;
      
      const member = results[index];
      selectedMemberData = member;
      
      // UIæ›´æ–°
      document.querySelectorAll('.result-item').forEach(function(item, i) {
        if (i === index) {
          item.classList.add('selected');
          item.querySelector('input[type="radio"]').checked = true;
        } else {
          item.classList.remove('selected');
          item.querySelector('input[type="radio"]').checked = false;
        }
      });
      
      // é¸æŠä¸­ã®ä¼šå“¡è¡¨ç¤º
      document.getElementById('selectedMemberId').textContent = member.memberId;
      document.getElementById('selectedStoreName').textContent = member.storeName;
      document.getElementById('selectedWearerName').textContent = member.wearerName;
      document.getElementById('selectedStatus').textContent = getStatusText(member.status);
      document.getElementById('selectedMember').classList.add('show');
      
      // ãƒœã‚¿ãƒ³æœ‰åŠ¹åŒ–
      document.getElementById('btnCard').disabled = false;
      document.getElementById('btnApplication').disabled = false;
      document.getElementById('btnBoth').disabled = false;
    }
    
    function clearSelection() {
      selectedMemberData = null;
      document.getElementById('selectedMember').classList.remove('show');
      document.getElementById('btnCard').disabled = true;
      document.getElementById('btnApplication').disabled = true;
      document.getElementById('btnBoth').disabled = true;
    }
    
    function getStatusClass(status) {
      if (!status) return 'status-pending';
      const s = status.toUpperCase();
      if (s === 'ACTIVE') return 'status-active';
      if (s === 'INACTIVE') return 'status-inactive';
      return 'status-pending';
    }
    
    function getStatusText(status) {
      if (!status) return 'æœªè¨­å®š';
      const s = status.toUpperCase();
      if (s === 'ACTIVE') return 'æœ‰åŠ¹';
      if (s === 'INACTIVE') return 'ç„¡åŠ¹';
      return status;
    }
    
    function escapeHtml(str) {
      if (!str) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }
    
    // ========== ã‚«ãƒ¼ãƒ‰ãƒ»ç”³è«‹æ›¸ç”Ÿæˆ ========== //
    
    async function generateCard() {
      if (!selectedMemberData) {
        showMessage('ä¼šå“¡ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
        return;
      }
      
      showLoading(true);
      hideMessage();
      
      try {
        const result = await callApi('generateCardByRow', { rowNumber: selectedMemberData.rowNumber });
        showLoading(false);
        
        if (result.success) {
          showSuccessWithLink(
            `âœ… ã‚«ãƒ¼ãƒ‰ç”Ÿæˆå®Œäº†\n\n` +
            `ä¼šå“¡ç•ªå·: ${result.memberId}\n` +
            `åº—å: ${result.storeName}\n` +
            `ç€ç”¨è€…: ${result.wearerName}`,
            result.slideUrl,
            'ğŸ« ã‚«ãƒ¼ãƒ‰ã‚’é–‹ã'
          );
        } else {
          showMessage('âŒ ã‚¨ãƒ©ãƒ¼: ' + result.error, 'error');
        }
      } catch (error) {
        showLoading(false);
        showMessage('âŒ ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
      }
    }
    
    async function generateApplication() {
      if (!selectedMemberData) {
        showMessage('ä¼šå“¡ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
        return;
      }
      
      showLoading(true);
      hideMessage();
      
      try {
        const result = await callApi('generateApplicationFormByRow', { rowNumber: selectedMemberData.rowNumber });
        showLoading(false);
        
        if (result.success) {
          showSuccessWithLink(
            `âœ… ç”³è«‹æ›¸ç”Ÿæˆå®Œäº†\n\n` +
            `ä¼šå“¡ç•ªå·: ${result.memberId}\n` +
            `åº—å: ${result.storeName}`,
            result.slideUrl,
            'ğŸ“‹ ç”³è«‹æ›¸ã‚’é–‹ã'
          );
        } else {
          showMessage('âŒ ã‚¨ãƒ©ãƒ¼: ' + result.error, 'error');
        }
      } catch (error) {
        showLoading(false);
        showMessage('âŒ ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
      }
    }
    
    async function generateBoth() {
      if (!selectedMemberData) {
        showMessage('ä¼šå“¡ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
        return;
      }
      
      showLoading(true);
      hideMessage();
      
      try {
        const rowNumber = selectedMemberData.rowNumber;
        
        // ç”³è«‹æ›¸ã¨ã‚«ãƒ¼ãƒ‰ã‚’ä¸¦åˆ—ã§ç”Ÿæˆ
        const [appResult, cardResult] = await Promise.all([
          callApi('generateApplicationFormByRow', { rowNumber }),
          callApi('generateCardByRow', { rowNumber })
        ]);
        
        showLoading(false);
        
        if (appResult.success && cardResult.success) {
          showSuccessWithLinks(
            `âœ… ç”³è«‹æ›¸ï¼‹ã‚«ãƒ¼ãƒ‰ç”Ÿæˆå®Œäº†\n\nä¼šå“¡ç•ªå·: ${appResult.memberId}`,
            [
              { url: appResult.slideUrl, label: 'ğŸ“‹ ç”³è«‹æ›¸ã‚’é–‹ã' },
              { url: cardResult.slideUrl, label: 'ğŸ« ã‚«ãƒ¼ãƒ‰ã‚’é–‹ã' }
            ]
          );
        } else {
          const errors = [];
          if (!appResult.success) errors.push('ç”³è«‹æ›¸: ' + appResult.error);
          if (!cardResult.success) errors.push('ã‚«ãƒ¼ãƒ‰: ' + cardResult.error);
          showMessage('âŒ ã‚¨ãƒ©ãƒ¼:\n' + errors.join('\n'), 'error');
        }
      } catch (error) {
        showLoading(false);
        showMessage('âŒ ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
      }
    }
    
    // ========== ä¸€æ‹¬å‡¦ç† ========== //
    
    async function generateTestCard() {
      showLoading(true);
      hideMessage();
      
      try {
        const result = await callApi('generateTestCard');
        showLoading(false);
        
        if (result.success) {
          showSuccessWithLink(
            `âœ… ãƒ†ã‚¹ãƒˆã‚«ãƒ¼ãƒ‰ç”Ÿæˆå®Œäº†\n\n` +
            `ä¼šå“¡ç•ªå·: ${result.memberId}\n` +
            `åº—å: ${result.storeName}\n` +
            `ç€ç”¨è€…: ${result.wearerName}`,
            result.slideUrl,
            'ğŸ« ãƒ†ã‚¹ãƒˆã‚«ãƒ¼ãƒ‰ã‚’é–‹ã'
          );
        } else {
          showMessage('âŒ ã‚¨ãƒ©ãƒ¼: ' + result.error, 'error');
        }
      } catch (error) {
        showLoading(false);
        showMessage('âŒ ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
      }
    }
    
    async function generateAllCards() {
      if (!confirm('å…¨ãƒ‡ãƒ¼ã‚¿ã®ã‚«ãƒ¼ãƒ‰ã‚’ä¸€æ‹¬ç”Ÿæˆã—ã¾ã™ã‹ï¼Ÿ\næ™‚é–“ãŒã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚')) {
        return;
      }
      
      showLoading(true);
      hideMessage();
      
      try {
        const result = await callApi('generateAllCards');
        showLoading(false);
        
        if (result.success) {
          showMessage(
            `âœ… ä¸€æ‹¬ç”Ÿæˆå®Œäº†\n\næˆåŠŸ: ${result.successCount}ä»¶\nã‚¨ãƒ©ãƒ¼: ${result.errorCount}ä»¶`,
            'success'
          );
        } else {
          showMessage('âŒ ã‚¨ãƒ©ãƒ¼: ' + result.error, 'error');
        }
      } catch (error) {
        showLoading(false);
        showMessage('âŒ ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
      }
    }
    
    async function generateAllApplications() {
      if (!confirm('å…¨ãƒ‡ãƒ¼ã‚¿ã®ç”³è«‹æ›¸ã‚’ä¸€æ‹¬ç”Ÿæˆã—ã¾ã™ã‹ï¼Ÿ\næ™‚é–“ãŒã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚')) {
        return;
      }
      
      showLoading(true);
      hideMessage();
      
      try {
        const result = await callApi('generateAllApplicationForms');
        showLoading(false);
        
        if (result.success) {
          showMessage(
            `âœ… ä¸€æ‹¬ç”Ÿæˆå®Œäº†\n\næˆåŠŸ: ${result.successCount}ä»¶\nã‚¨ãƒ©ãƒ¼: ${result.errorCount}ä»¶`,
            'success'
          );
        } else {
          showMessage('âŒ ã‚¨ãƒ©ãƒ¼: ' + result.error, 'error');
        }
      } catch (error) {
        showLoading(false);
        showMessage('âŒ ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
      }
    }
    
    // ========== UI ãƒ˜ãƒ«ãƒ‘ãƒ¼ ========== //
    
    function showLoading(show) {
      document.getElementById('loading').style.display = show ? 'block' : 'none';
    }
    
    function showMessage(text, type) {
      const messageEl = document.getElementById('message');
      messageEl.textContent = text;
      messageEl.className = 'message ' + type;
      messageEl.style.display = 'block';
    }
    
    function hideMessage() {
      document.getElementById('message').style.display = 'none';
    }
    
    function showSuccessWithLink(text, url, linkLabel) {
      const messageEl = document.getElementById('message');
      messageEl.innerHTML = '';
      messageEl.className = 'message success';
      
      const textNode = document.createElement('div');
      textNode.style.whiteSpace = 'pre-line';
      textNode.textContent = text;
      messageEl.appendChild(textNode);
      
      const link = document.createElement('div');
      link.className = 'result-link';
      link.innerHTML = `<a href="${url}" target="_blank">${linkLabel}</a>`;
      messageEl.appendChild(link);
      
      messageEl.style.display = 'block';
    }
    
    function showSuccessWithLinks(text, links) {
      const messageEl = document.getElementById('message');
      messageEl.innerHTML = '';
      messageEl.className = 'message success';
      
      const textNode = document.createElement('div');
      textNode.style.whiteSpace = 'pre-line';
      textNode.textContent = text;
      messageEl.appendChild(textNode);
      
      links.forEach(function(linkInfo) {
        const link = document.createElement('div');
        link.className = 'result-link';
        link.innerHTML = `<a href="${linkInfo.url}" target="_blank">${linkInfo.label}</a>`;
        messageEl.appendChild(link);
      });
      
      messageEl.style.display = 'block';
    }
    
    // ========== åˆæœŸåŒ– ========== //
    
    window.onload = function() {
      // æœ€æ–°20ä»¶ã‚’è‡ªå‹•ãƒ­ãƒ¼ãƒ‰
      loadRecentMembers();
    };
  </script>
</body>
</html>
